
ä¸‹é¢å°†å±•ç¤ºå¦‚ä½•ç¼–å†™[PWA](https://en.wikipedia.org/wiki/Progressive_web_app)åº”ç”¨ç¨‹åºçš„ç¤ºä¾‹ï¼Œæ—¨åœ¨åœ¨æµè§ˆå™¨å’ŒWindowsæ“ä½œç³»ç»Ÿè®¡ç®—æœºä¸Šå‡å¯ä½¿ç”¨ã€‚æˆ‘ä»¬å°†ä½¿ç”¨Rustç¼–ç¨‹è¯­è¨€å’Œeframeæ¡†æ¶([egui](https://github.com/emilk/egui#quick-start))ã€‚å®Œæˆçš„åº”ç”¨ç¨‹åºå°†ä½œä¸ºWindowsæ“ä½œç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶å’ŒWebassemblyæ–‡ä»¶æä¾›ã€‚åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨GitHub Actionæ¥ç›‘æ§æˆ‘ä»¬ä»£ç çš„æ­£ç¡®æ€§å¹¶æ„å»ºå¯æ‰§è¡Œç¨‹åºæ–‡ä»¶ï¼ŒåŒæ—¶ä½¿ç”¨Webassemblyéƒ¨ç½²åº”ç”¨ç¨‹åºç‰ˆæœ¬ä½œä¸ºç½‘é¡µ(GitHub Pages)ã€‚

![Screenshot7](img/Screenshot7.png)

## ä½œè€…çš„åŠ¨æœº

åœ¨å·¥ä½œä¹‹ä½™ï¼Œæˆ‘ç»å¸¸ä¼šèŠ±æ—¶é—´ç ”ç©¶ä¸åŒç¼–ç¨‹è¯­è¨€åŠå…¶ç”Ÿæ€ç³»ç»Ÿã€‚æœ€è¿‘ï¼Œæˆ‘å°†æ³¨æ„åŠ›è½¬å‘äº†Rustç¼–ç¨‹è¯­è¨€ã€‚åœ¨ç»§ç»­äº†è§£Rustç”Ÿæ€ç³»ç»Ÿçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å¼€å§‹ç ”ç©¶ç”¨äºæ„å»ºç”¨æˆ·å›¾å½¢ç•Œé¢çš„å·¥å…·ã€‚ä¸å¾—ä¸è¯´ï¼Œæˆ‘æ„Ÿåˆ°éå¸¸æƒŠè®¶ï¼Œæ— è®ºæ˜¯æ­£é¢è¿˜æ˜¯è´Ÿé¢ã€‚

ä»¤äººæ¬£å–œçš„æ˜¯ï¼š

- æœ‰éå¸¸[å¤š](https://www.areweguiyet.com/)çš„ç”¨äºåˆ›å»ºGUIçš„åº“å’Œæ¡†æ¶å¯ä¾›é€‰æ‹©ï¼Œæœ‰äº›å®Œå…¨ä½¿ç”¨Rustç¼–å†™ï¼Œæœ‰äº›åˆ™æ˜¯å¯¹å…¶ä»–è¯­è¨€å·¥å…·çš„å°è£…ï¼›
- å…¶ä¸­è®¸å¤šå¯ç”¨äºè·¨å¹³å°å¼€å‘ï¼ŒåŒ…æ‹¬å°†åº”ç”¨ç¨‹åºç¼–è¯‘ä¸º [WASM](https://en.wikipedia.org/wiki/WebAssembly) å¹¶å°†å…¶å‘å¸ƒä¸ºç½‘é¡µçš„åŠŸèƒ½ã€‚

ä»¤äººæ²®ä¸§çš„æ˜¯ï¼š

- åŒæ ·ï¼Œæœ‰å¾ˆå¤šç”¨äºåˆ›å»ºGUIçš„åº“å’Œæ¡†æ¶ï¼Œå‡ ä¹æ‰€æœ‰è¿™äº›åº“éƒ½å£°ç§°å°šä¸å¯ç”¨ï¼Œå¹¶ä¸”ä»å¤„äºå®éªŒé˜¶æ®µï¼ˆä¾‹å¦‚ï¼Œ[Druid](https://github.com/linebender/druid) é¡¹ç›®ï¼Œå…¶ä¸»è¦å›¢é˜Ÿå·²ç»åœæ­¢å¼€å‘å¹¶ä¸“æ³¨äºæ–°é¡¹ç›® [Xilem](https://github.com/linebender/xilem)ã€‚æ˜¯çš„ï¼Œè¿™ä¸ªæ–°é¡¹ç›®ä¹Ÿè¿˜ä¸ç¨³å®šã€‚

æœ€å¸å¼•æˆ‘æ³¨æ„çš„æ˜¯å¯ä»¥å°†åº”ç”¨ç¨‹åºç¼–è¯‘ä¸º [WASM](https://en.wikipedia.org/wiki/WebAssembly) å¹¶å°†å…¶å‘å¸ƒä¸ºç½‘é¡µçš„åŠŸèƒ½ã€‚æˆ‘æƒ³ï¼Œâ€œè¿™æ˜¯æ˜å¤©æˆ–æ˜¨å¤©çš„è¶‹åŠ¿â€ï¼Œæ— è®ºå¦‚ä½•éƒ½åº”è¯¥å…³æ³¨è¿™ä¸ªæ–¹å‘ï¼ˆç¨å¾®æœ‰äº›è™šå‡ï¼Œå› ä¸ºä¸€ä¸¤å¹´å‰æˆ‘æ›¾å°è¯•ä½¿ç”¨Rust + [Yew](https://github.com/yewstack/yew) åˆ›å»º [æµ·æˆ˜æ¸¸æˆ](https://mae664128.github.io/sea_battle/) ï¼‰ã€‚

å°½ç®¡æœ‰è®¸å¤šç”¨äºå¼€å‘ç”¨æˆ·ç•Œé¢çš„å·¥å…·å¯ä¾›é€‰æ‹©ï¼Œä½†æˆ‘çš„é€‰æ‹©æ˜¯[EGUI](https://github.com/emilk/egui#quick-start)ã€‚å¹¶ä¸æ˜¯å› ä¸ºæˆ‘è¿›è¡Œäº†æ·±å…¥ç ”ç©¶ï¼Œåˆ¶ä½œäº†è¡¨æ ¼ï¼Œæƒè¡¡äº†åˆ©å¼Šï¼Œè€Œæ˜¯å› ä¸ºæˆ‘è¢«è¿™ä¸ª[ç¤ºä¾‹](https://www.egui.rs/#demo)æ‰€å¸å¼•ã€‚

1. ## å·¥ä½œè®¡åˆ’

   1. ç¡®å®šæœ€ä½è¦æ±‚é›†ï¼ˆæˆ‘ä»¬æƒ³è¦ä»€ä¹ˆï¼‰ã€‚
   2. å‡†å¤‡å¹¶è§£æåº”ç”¨ç¨‹åºæ¨¡æ¿ã€‚
   3. å‡†å¤‡GitHub Actionsï¼Œä»¥ä¾¿è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒæˆ‘ä»¬çš„æˆæœã€‚
   4. å¼€å‘ç®€å•ç•Œé¢ã€‚
   5. ä¸ºæˆ‘ä»¬çš„é—®é¢˜å¼€å‘ç®€å•çš„æ±‚è§£å™¨ã€‚

## ç»“æœè¦æ±‚

åœ¨æ‰€æœ‰å·¥ä½œå®Œæˆåï¼Œå¸Œæœ›è·å¾—ä¸€ä¸ªå¯ç”¨çš„è®¡ç®—å™¨ç•Œé¢ï¼Œå¯ä½œä¸ºç½‘ç»œé¡µé¢ï¼ˆPWAï¼‰åœ¨äº’è”ç½‘ä¸Šè®¿é—®ï¼Œä¹Ÿå¯ä½œä¸ºWindowsæ“ä½œç³»ç»Ÿçš„å¯æ‰§è¡Œæ–‡ä»¶ä½¿ç”¨ã€‚

*ä¸ºä»€ä¹ˆæ˜¯è®¡ç®—å™¨ï¼Ÿ*
*å¶ç„¶çœ‹åˆ°äº†æœ‰å…³[é€†æ³¢å…°è¡¨ç¤ºæ³•](#é€†æ³¢å…°è¡¨ç¤ºæ³•)çš„æ–‡ç« ï¼Œé˜…è¯»åå†³å®šå°è¯•å®ç°å®ƒã€‚è€Œä¸”ï¼Œè‡³å°‘æˆ‘å·²ç»çŸ¥é“å¦‚ä½•è®¡ç®—2 + 2ï¼Œä¸ºä»€ä¹ˆä¸è¯•ç€åšä¸€ä¸ªç›¸åº”çš„å›¾å½¢ç•Œé¢å‘¢ã€‚*

åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œæˆ‘å¸Œæœ›ä¸“æ³¨äºæœ€é‡è¦çš„äº‹æƒ… - å¼€å‘ï¼Œè€Œä¸æ˜¯å°†æ—¶é—´èŠ±åœ¨éƒ¨ç½²åº”ç”¨ç¨‹åºåˆ°äº’è”ç½‘ä¸Šå’Œå°†å·²æ„å»ºçš„å¯æ‰§è¡Œæ–‡ä»¶å‘å¸ƒåˆ°å…¬å…±è®¿é—®ã€‚å› æ­¤ï¼Œé¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªç®€å•çš„é¡¹ç›®æ¨¡æ¿ï¼Œå¹¶è®¾ç½®ï¼ˆåŸºæœ¬ï¼‰CI/CDï¼Œä½¿ç”¨GitHub Actionå’ŒGitHub Pagesã€‚

## 1 å‡†å¤‡æ¨¡æ¿

### 1.1 åˆå§‹åŒ–é¡¹ç›®

åœ¨å¼€å§‹ä¹‹å‰ï¼Œç¡®ä¿å·²å®‰è£…äº† Rustã€‚

```bash
$ rustup --version
rustup 1.25.2 (17db695f1 2023-02-01)
info: This is the version for the rustup toolchain manager, not the rustc compiler.
info: The currently active `rustc` version is `rustc 1.67.1 (d5a82bbd2 2023-02-07)`
```

æˆ‘ä»¬é€šè¿‡è¿è¡Œ `cargo new <project-name>` å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š

```bash
$ cargo new calculator-wasm-rust-pwa --bin
     Created binary (application) `calculator-wasm-rust-pwa` package
```

ç”±äºæˆ‘ä»¬æƒ³è¦ä¸€ä¸ªå¯æ‰§è¡Œæ–‡ä»¶è€Œä¸æ˜¯åº“ï¼Œæ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨äº† `--bin` æ ‡è®°ã€‚

è®©æˆ‘ä»¬è¿˜åœ¨é¡¹ç›®ä¸­æ·»åŠ ä¸€ä¸ª `src/lib.rs` æ–‡ä»¶ï¼š

```bash
$ touch calculator-wasm-rust-pwa/src/lib.rs
```

è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ Cargo ä¸ºæˆ‘ä»¬ç”Ÿæˆäº†ä»€ä¹ˆï¼š

```bash
$ cd calculator-wasm-rust-pwa/
$ tree .
.
â”œâ”€â”€ .gitignore
â”œâ”€â”€ Cargo.toml
â””â”€â”€ src
    â””â”€â”€ main.rs
```

`Cargo.toml` æ–‡ä»¶ä¸­åŒ…å«äº†å…³äºæˆ‘ä»¬é¡¹ç›®çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æˆ‘ä»¬é¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰åŒ…ï¼ˆä¾èµ–é¡¹ï¼‰çš„åˆ—è¡¨ã€‚æˆ‘ä»¬å°†åœ¨ `src\` æ–‡ä»¶å¤¹ä¸­æ”¾ç½®æˆ‘ä»¬çš„ä»£ç ã€‚

### 1.2 å‘é¡¹ç›®æ·»åŠ å¿…è¦çš„ä¾èµ–é¡¹

ç”±äºæˆ‘ä»¬é€‰æ‹©äº† [EGUI](https://github.com/emilk/egui#quick-start)ï¼Œå¹¶ä¸”æˆ‘ä»¬å¸Œæœ›ç¼–å†™ä¸€ä¸ªå¯ä»¥åœ¨äº’è”ç½‘å’Œæœ¬åœ°è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œå› æ­¤é¦–å…ˆæ·»åŠ  `eframe` - è¿™æ˜¯ä½¿ç”¨ egui ç¼–å†™åº”ç”¨ç¨‹åºçš„å®˜æ–¹æ¡†æ¶åº“ã€‚

```bash
$ cargo add eframe --no-default-features -F default_fonts -F glow -F persistence
```

å¯¹äºæ·»åŠ  eframe çš„è¯´æ˜ï¼š
	- `default_fonts` - å…è®¸æˆ‘ä»¬å°† egui çš„é»˜è®¤å­—ä½“æ·»åŠ åˆ°é¡¹ç›®ä¸­ã€‚
	- `glow` - å‘Šè¯‰ egui ä½¿ç”¨ glow ä½œä¸ºæ¸²æŸ“åç«¯ã€‚å…¶ä»–é€‰æ‹©åŒ…æ‹¬ï¼š"wgpu"ã€‚
	- `persistence` - å…è®¸æˆ‘ä»¬å®ç°åº”ç”¨ç¨‹åºé‡å¯åçŠ¶æ€çš„æ¢å¤ã€‚

æš‚æ—¶å°±è¿™äº›ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬çš„ Cargo.toml æ–‡ä»¶çœ‹èµ·æ¥åƒè¿™æ ·ï¼š

```toml
# ./Cargo.toml

[package]
version = "0.1.0"
name = "calculator-wasm-rust-pwa"
description = "A simple calculator created to demonstrate how to work with web gui on rust."
authors = ["Matkin Alexandr <mae664128@gmail.com>"]
edition = "2021"
rust-version = "1.67.1"

[dependencies]
eframe = { version = "0.21.3", default-features = false, features = ["default_fonts", "glow", "persistence"] }

[profile.release]
opt-level = 2 # fast and small wasm
codegen-units = 1
lto = true
panic = "abort"

# Optimize all dependencies even in debug builds:
[profile.dev.package."*"]
opt-level = 2
```

ä½ å¯èƒ½æ³¨æ„åˆ°æˆ‘çš„ Cargo.toml æ–‡ä»¶ä¸­æœ‰ä¸€äº›é¢å¤–çš„éƒ¨åˆ†ï¼Œä½ å¯èƒ½æ²¡æœ‰ã€‚å¦‚æœä½ ä¸çŸ¥é“å®ƒä»¬çš„ä½œç”¨ï¼Œå¹¶ä¸”ä¸ç¡®å®šå®ƒä»¬æ˜¯å¦é€‚ç”¨äºä½ ï¼Œä¸€å®šè¦é˜…è¯» [The Manifest Format - The Cargo Book](https://doc.rust-lang.org/cargo/reference/manifest.html) ä¸­å…³äºå®ƒä»¬çš„å†…å®¹ã€‚

### 1.3 ç¼–å†™æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªç•Œé¢ä»£ç 

å€ŸåŠ©äº [eframe æ–‡æ¡£](https://docs.rs/eframe/latest/eframe/) ä¸­çš„ç¤ºä¾‹ï¼Œç¨ä½œä¿®æ”¹ï¼Œå°è¯•ç¼–å†™å¸¦æœ‰æˆ‘ä»¬ç¬¬ä¸€ä¸ªç•Œé¢çš„ä»£ç ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬æŒ‰ä»¥ä¸‹æ–¹å¼ç¼–è¾‘ `./src/main.rs` æ–‡ä»¶ï¼š

```rust
// ./src/main.rs
#![cfg_attr(not(debug_assertions), windows_subsystem = "windows")] // hide console window on Windows in release

use eframe::egui;

fn main() -> eframe::Result<()> {
    eframe::run_native(
        "calculator-wasm-rust-pwa",
        eframe::NativeOptions::default(),
        Box::new(|cc| Box::new(CalcApp::new(cc))),
    )
}

struct CalcApp {}

impl CalcApp {
    fn new(_cc: &eframe::CreationContext<'_>) -> Self {
        CalcApp {}
    }
}

impl eframe::App for CalcApp {
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {
        egui::CentralPanel::default().show(ctx, |ui| {
            ui.label(r#"
            This is a fictional calculator.

To use the calculator, you need to use your imagination. Imagine any interface, type a mathematical expression in it, and press '='.
See the result, right? - Congratulations, your calculator works well.
            "#);
        });
    }
}
```

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬å…ˆæ¾„æ¸…ä¸€ä¸‹è¿™é‡Œçš„ä»£ç ã€‚æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„èµ·ç‚¹æ˜¯ `main()` å‡½æ•°ã€‚

```rust
// ./src/main.rs
// ... 
fn main() -> eframe::Result<()> {
    eframe::run_native(
        "calculator-wasm-rust-pwa",
        eframe::NativeOptions::default(),
        Box::new(|cc| Box::new(CalcApp::new(cc))),
    )
}
// ...
```

é€šè¿‡ä½¿ç”¨ `eframe::run_native` å‡½æ•°ï¼Œæˆ‘ä»¬å°†è¿è¡Œæˆ‘ä»¬è‡ªå·±çš„ï¼ˆæœ¬åœ°ï¼‰åº”ç”¨ç¨‹åºã€‚è¯¥å‡½æ•°æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

- `app_name`ï¼ˆç¬¬ä¸€è¡Œï¼‰ - è¿™æ˜¯æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„åç§°ã€‚å®ƒå°†ç”¨ä½œæœ¬æœºçª—å£æ ‡é¢˜æ çš„å­—ç¬¦ä¸²ã€‚
- `native_options`ï¼ˆç¬¬äºŒè¡Œï¼‰ - è¿™æ˜¯ `NativeOptions` ç»“æ„ï¼Œç”¨äºæ§åˆ¶æœ¬æœºçª—å£çš„è¡Œä¸ºã€‚æˆ‘ä»¬ç¨åä¼šå†æåŠå¦‚ä½•é…ç½®æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œä½†ç°åœ¨æˆ‘ä»¬å°†ä½¿ç”¨ `eframe::NativeOptions::default()` å®ç°çš„é»˜è®¤é…ç½®ã€‚
- `app_creator`ï¼ˆç¬¬ä¸‰è¡Œï¼‰ - åœ¨è¿™é‡Œä½ åˆ›å»ºä½ çš„åº”ç”¨ç¨‹åºã€‚

æˆ‘ä»¬å·²ç»å°†æˆ‘ä»¬ç¼–å†™çš„ `CalcApp::new(cc)` ç»“æ„æŒ‡å®šä¸º app_creatorï¼Œè¯¥ç»“æ„å®ç°äº† `eframe::App` traitã€‚

```rust
// ./src/main.rs
// ... 
struct CalcApp {}

impl CalcApp {
    fn new(_cc: &eframe::CreationContext<'_>) -> Self {
        CalcApp {}
    }
}

impl eframe::App for CalcApp {
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {
        egui::CentralPanel::default().show(ctx, |ui| {
            ui.label(r#"
            This is a fictional calculator.

To use the calculator, you need to use your imagination. Imagine any interface, type a mathematical expression in it, and press '='.
See the result, right? - Congratulations, your calculator works well.
            "#);
        });
    }
}
```

æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªç©ºçš„ `CalcApp` ç»“æ„ï¼Œå¹¶å®ç°äº† `new()` å‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ç¬¬ä¸€å¸§ä¹‹å‰è¢«è°ƒç”¨ä¸€æ¬¡ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†åˆå§‹åŒ–æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å‚æ•°ã€‚
æœ€é‡è¦çš„å‡½æ•°æ˜¯æˆ‘ä»¬å¼€å§‹æ„å»ºæˆ‘ä»¬ç•Œé¢çš„ `update` å‡½æ•°ï¼Œå®ƒæ¥è‡ª `eframe::App` traitã€‚è¯¥å‡½æ•°å°†åœ¨éœ€è¦é‡æ–°ç»˜åˆ¶ç”¨æˆ·ç•Œé¢æ—¶è°ƒç”¨ï¼Œè¿™å¯èƒ½æ¯ç§’å‘ç”Ÿå¤šæ¬¡ã€‚åœ¨è¯¥å‡½æ•°å†…éƒ¨ï¼Œæˆ‘ä»¬å°†åœ¨ `SidePanel`ã€`TopPanel`ã€`CentralPanel`ã€`Window` æˆ– `Area` ä¸­æ”¾ç½®æˆ‘ä»¬çš„å°éƒ¨ä»¶ã€‚

å°è¯•è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼š

```bash
$ cargo run
```

å®Œæˆäº†ã€‚è®¡ç®—å™¨å·²ç»å‡†å¤‡å°±ç»ªã€‚è§£æ•£å§ã€‚
![Screenshot0.png](https://img-storage-202310-1321408411.cos.ap-nanjing.myqcloud.com/img/202310301152676.png)

ç°åœ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå·²ç»æ„å»ºå¹¶è¿è¡Œäº†ï¼Œå¦‚æœæˆ‘ä»¬æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—å¯æ‰§è¡Œæ–‡ä»¶ï¼š

```bash
$ cargo build --release
```

ç„¶è€Œï¼Œè·å¾—å¯æ‰§è¡Œæ–‡ä»¶åªå®Œæˆäº†ç›®æ ‡çš„ä¸€åŠã€‚æˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿå°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ„å»ºä¸ºä¸€ç»„æ–‡ä»¶ï¼Œä»¥ä¾¿å¯ä»¥åœ¨äº’è”ç½‘ä¸Šéƒ¨ç½²ã€‚æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®é¢˜ã€‚



### 1.4 é€šè¿‡æ·»åŠ  Wasm ç¼–è¯‘èƒ½åŠ›æ¥ä¿®æ”¹ä»£ç 

#### 1.4.1 å®‰è£… Trunk

æˆ‘ä»¬å°†ä½¿ç”¨ [Trunk](https://trunkrs.dev/) å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ„å»ºä¸º Wasm æ–‡ä»¶ã€‚

é€šè¿‡ä»¥ä¸‹å‘½ä»¤å®‰è£… Trunkï¼š

```bash
$ cargo install --locked trunk
```

ä½†æ˜¯ï¼Œå¦‚æœä½ å°è¯•æ„å»ºåº”ç”¨ç¨‹åºå¹¶ä½¿ç”¨å¼€å‘æœåŠ¡å™¨è¿è¡Œå®ƒï¼š

```bash
$ trunk serve
```

ä½ ä¼šé‡åˆ°ä¸€äº›é”™è¯¯ï¼Œå‘Šè¯‰æˆ‘ä»¬æˆ‘ä»¬çš„é¡¹ç›®è¿˜æ²¡æœ‰å‡†å¤‡å¥½ã€‚è®©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

#### 1.4.2 åˆ›å»º index.html æ–‡ä»¶å’Œå…¶ä»–æ–‡ä»¶

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º `index.html` æ–‡ä»¶ã€‚è®©æˆ‘ä»¬ä½¿ç”¨æ­¤[ç¤ºä¾‹](https://github.com/emilk/eframe_template/)ä¸­å‡†å¤‡çš„æ–‡ä»¶ï¼Œå¹¶æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚å°† `index.html` å’Œ `assets\` ç›®å½•å¤åˆ¶åˆ°æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œä½¿å¾—é¡¹ç›®çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š

```bash
$ cd calculator-wasm-rust-pwa/
$ tree .
H:.
â”‚   .gitignore
â”‚   Cargo.toml
â”‚   index.html
â”œâ”€â”€â”€assets\
â”‚       favicon.ico
â”‚       icon-1024.png
â”‚       icon-256.png
â”‚       icon_ios_touch_192.png
â”‚       manifest.json
â”‚       maskable_icon_x512.png
â”‚       sw.js
â””â”€â”€â”€src\
        main.rs
```

æˆ‘ä¸ä¼šè¯¦ç»†è§£é‡Š `index.html` å’Œ `sw.js` æ–‡ä»¶çš„ç‰¹æ€§ï¼Œä½†åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿æŸ¥é˜… [Trunk æ–‡æ¡£](https://trunkrs.dev/) å’Œ Service Workers çš„ä½¿ç”¨æ–¹æ³•ã€‚

#### 1.4.3 ç”Ÿæˆ favicon.ico

è¿™å¾ˆç®€å•ã€‚æˆ‘ä»¬è¿›å…¥ [stable diffusion web](https://stablediffusionweb.com/#demo) å¹¶ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å®ƒæ¥åˆ›å»ºå›¾æ ‡ - `favicon.ico`ã€‚

![Pasted image 20230218171015.png](img/Pasted%20image%2020230218171015.png)

#### 1.4.4 ä¿®æ”¹ main.rs ä»£ç ä»¥ä¾¿è¿›è¡Œ Wasm ç¼–è¯‘

å¦‚æœæˆ‘ä»¬å°è¯•ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤å°†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºç¼–è¯‘ä¸º Wasmï¼š

```bash
$ trunk build
```

æˆ‘ä»¬å°†ä¼šé‡åˆ°ç¼–è¯‘é”™è¯¯ï¼š

```bash
error[E0433]: failed to resolve: could not find `NativeOptions` in `eframe`                                                  
  --> src\main.rs:8:17
   |
 8 |         eframe::NativeOptions::default(),
   |                 ^^^^^^^^^^^^^ could not find `NativeOptions` in `eframe`

error[E0425]: cannot find function `run_native` in crate `eframe`
  --> src\main.rs:6:13
   |
 6 |     eframe::run_native(
   |             ^^^^^^^^^^ not found in `eframe`

ä¸€äº›é”™è¯¯æœ‰è¯¦ç»†çš„è§£é‡Šï¼šE0425, E0433ã€‚

ç¼–è¯‘å™¨å‘Šè¯‰æˆ‘ä»¬åœ¨ `eframe` ä¸­æ‰¾ä¸åˆ° `run_native()`ã€‚ä½†è¿™ä¸å¯èƒ½ï¼Œå› ä¸ºå½“æˆ‘ä»¬ä½¿ç”¨ `cargo run` å‘½ä»¤æ—¶ï¼Œè¿™æ®µä»£ç å·²ç»èƒ½å¤Ÿæ­£å¸¸å·¥ä½œäº†ã€‚

é—®é¢˜åœ¨äºè¿™ä¸€[è¡Œ](https://github.com/emilk/egui/blob/master/crates/eframe/src/lib.rs#L181)ï¼š

```rust
#[cfg(not(target_arch = "wasm32"))]
```

ä½äº `run_native()` å‡½æ•°çš„æ³¨è§£ä¹‹å‰ã€‚æ‚¨å¯ä»¥åœ¨ [Rust ğŸ¦€ and WebAssembly](https://rustwasm.github.io/docs/book/reference/add-wasm-support-to-crate.html#maybe-your-crate-already-supports-webassembly) æ–‡æ¡£ä¸­è¯¦ç»†äº†è§£æ­¤è¡Œçš„å«ä¹‰ï¼Œä»¥åŠåœ¨ Rust ä¸­ä½¿ç”¨ Wasm çš„ç¼–è¯‘ç‰¹æ€§ã€‚

è®©æˆ‘ä»¬ä¿®æ”¹æˆ‘ä»¬çš„ `./src/main.rs` æ–‡ä»¶ã€‚

```rust
// ./src/main.rs
// ... 

// åœ¨å‡½æ•°æ³¨è§£ä¹‹å‰æ·»åŠ äº†ä¸€è¡Œæ–°ä»£ç 
#[cfg(not(target_arch = "wasm32"))]  
fn main() -> eframe::Result<()>  { ... }  

// ä¸ºäº†ä½¿ç”¨ trunk ç¼–è¯‘ï¼Œæˆ‘ä»¬æ·»åŠ äº† main() å‡½æ•°ã€‚
#[cfg(target_arch = "wasm32")]
fn main() {  
    // ç¡®ä¿ panic é€šè¿‡ `console.error` æ³¨å†Œã€‚
    console_error_panic_hook::set_once();  
    wasm_bindgen_futures::spawn_local(async {  
        eframe::start_web(  
            "calculator-wasm-rust-pwa",  
            eframe::WebOptions::default(),  
            Box::new(|cc| Box::new(CalcApp::new(cc))),  
        )  
            .await  
            .expect("failed to start calculator-wasm-rust-pwa");  
    });  
}
// ...

```

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬çš„ `CalcApp::new()` åº”ç”¨ç¨‹åºä¿æŒä¸å˜ã€‚æˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„ä»£ç åœ¨æœ¬æœºåº”ç”¨ç¨‹åºå’Œ Web ä¸­è¿è¡Œã€‚

è¯·ä»”ç»†æŸ¥çœ‹æ–°ä»£ç ã€‚`eframe::start_web()` ä¸­ä¼ é€’çš„å‚æ•°ä¸ `eframe::run_native()` ç›¸ä¼¼ã€‚

åœ¨è¿™æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸¤ä¸ªæ–°çš„ crate çš„å‡½æ•°è°ƒç”¨:

- `console_error_panic_hook` - å…è®¸è°ƒè¯• `wasm32-unknown-unknown` ä¸­çš„ panicï¼Œæä¾› panic æ•è·å™¨ã€‚`console_error_panic_hook::set_once()` å°† panic æ¶ˆæ¯é‡å®šå‘åˆ° `console.error`ã€‚
- `wasm_bindgen_futures` - æä¾›äº†å°† JavaScript çš„ Promise ç±»å‹ä½œä¸º Rust Future ä½¿ç”¨çš„æ¡¥æ¢ã€‚`spawn_local` å‡½æ•°åœ¨å½“å‰çº¿ç¨‹ä¸­è¿è¡Œ Rust Futureã€‚

ä¸ºäº†ä½¿æˆ‘ä»¬çš„ä»£ç å·¥ä½œï¼Œè®©æˆ‘ä»¬åœ¨ `./Cargo.toml` æ–‡ä»¶ä¸­æ·»åŠ æ‰€éœ€çš„ä¾èµ–é¡¹:

```toml
# ...
# web:  
[target.'cfg(target_arch = "wasm32")'.dependencies]  
console_error_panic_hook = "0.1.7"  
tracing-wasm = "0.2"  
wasm-bindgen-futures = "0.4"
# ...
```

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œæä¾› trunk çš„å¼€å‘æœåŠ¡å™¨:

```bash
$ trunk serve
```

æˆ‘ä»¬å¯ä»¥ç¡®ä¿ä¸€åˆ‡æ­£å¸¸ï¼Œå¹¶é€šè¿‡æµè§ˆå™¨è®¿é—®åœ°å€ http://127.0.0.1:8080:

```bash
$ trunk serve

Compiling calculator-wasm-rust-pwa v0.1.0 (H:\GOOGLE_20220408\DEVELOPER\calculator-wasm-rust-pwa)
    Finished dev [unoptimized + debuginfo] target(s) in 3.61s                                                                                    
2023-02-25T13:11:15.732104Z  INFO fetching cargo artifacts
2023-02-25T13:11:16.009440Z  INFO processing WASM for calculator-wasm-rust-pwa
2023-02-25T13:11:16.210436Z  INFO calling wasm-bindgen for calculator-wasm-rust-pwa
2023-02-25T13:11:16.542757Z  INFO copying generated wasm-bindgen artifacts
2023-02-25T13:11:16.578580Z  INFO applying new distribution
2023-02-25T13:11:16.582748Z  INFO  success
2023-02-25T13:11:16.587400Z  INFO  serving static assets at -> /
2023-02-25T13:11:16.588514Z  INFO  server listening at http://127.0.0.1:8080


```

![Screenshot1.png](https://img-storage-202310-1321408411.cos.ap-nanjing.myqcloud.com/img/202310301157032.png)

å½“æˆ‘ä»¬åœ¨é¡¹ç›®ç›®å½•ä¸­è¿è¡Œ trunk dev server æ—¶ï¼Œå°†ä¼šç”Ÿæˆä¸€ä¸ª `dist/` æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«äº†ç”¨äºéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶é›†åˆã€‚

## 2. é…ç½® GitHub Action

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æˆ‘ä»¬æ‰€æ‹¥æœ‰çš„å†…å®¹ï¼š

- é€šè¿‡è¿è¡Œ`cagro build --release`å‘½ä»¤ï¼Œæˆ‘ä»¬å°†è·å¾—æˆ‘ä»¬åº”ç”¨ç¨‹åºçš„å¯æ‰§è¡Œæ–‡ä»¶
- é€šè¿‡è¿è¡Œ`trunk build --release`å‘½ä»¤ï¼Œæˆ‘ä»¬å°†è·å¾—ä¸€ç»„æ–‡ä»¶ï¼ŒåŒ…æ‹¬`index.html`ï¼Œè¿™äº›æ–‡ä»¶å·²ç»å‡†å¤‡å¥½æ”¾ç½®åœ¨æˆ‘ä»¬çš„å…¬å…±æœåŠ¡å™¨ä¸Šã€‚

æ¥ä¸‹æ¥ï¼Œè®©æˆ‘ä»¬å°è¯•å°†æˆ‘ä»¬çš„ Web åº”ç”¨ç¨‹åºæ–‡ä»¶æ”¾ç½®åœ¨ GitHub é¡µé¢ä¸Šã€‚ä¸ºäº†é¿å…æ¯æ¬¡æ‰‹åŠ¨æ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ GitHub Actionsã€‚

GitHub å·²ç»ä¸º Rust è¯­è¨€å‡†å¤‡äº†ä¸€äº›é¢„å…ˆé…ç½®çš„ yml æ–‡ä»¶ï¼Œä½†æˆ‘ä»¬ä¸æ‰“ç®—ä½¿ç”¨å®ƒä»¬ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸[ç¤ºä¾‹](https://github.com/emilk/eframe_template/)ç›¸åŒçš„ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…æ‹¬å›¾æ ‡å’Œ`index.html`æ–‡ä»¶ã€‚

åœ¨æˆ‘ä»¬é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªåä¸º`.github/workflows/`çš„æ–‡ä»¶å¤¹ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºä¸‰ä¸ªæ–‡ä»¶ï¼š

- `rust.yml` - åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†é…ç½®æˆ‘ä»¬çš„ CIï¼Œå®ƒå°†è´Ÿè´£æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š
  - ä½œä¸š: æ£€æŸ¥ï¼š- æ‰§è¡Œ`cargo check`å‘½ä»¤ï¼Œç”¨äºæ£€æŸ¥æœ¬åœ°åŒ…åŠå…¶æ‰€æœ‰ä¾èµ–é¡¹æ˜¯å¦å­˜åœ¨é”™è¯¯ã€‚
  - ä½œä¸š: æ£€æŸ¥_wasmï¼šæ‰§è¡Œ`cargo check --all-features --lib --target wasm32-unknown-unknown`å‘½ä»¤ï¼Œå…¶æœ¬è´¨ä¸Šç±»ä¼¼äºå‰ä¸€ä¸ªå‘½ä»¤ï¼Œä½†æ˜¯é’ˆå¯¹æ£€æŸ¥ wasm32-unknown-unknown ç›®æ ‡ä¸‰å…ƒç»„ã€‚
  - ä½œä¸š: æµ‹è¯•ï¼š- ä½¿ç”¨`cargo test --lib`å‘½ä»¤è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ï¼Œä¸éœ€è¦ä»»ä½•è¯´æ˜ã€‚
  - ä½œä¸š: Clippyï¼š- ä½¿ç”¨ Rust ä¸­éå¸¸æµè¡Œçš„ä»£ç æ£€æŸ¥å·¥å…· - [clippy](https://github.com/rust-lang/rust-clippy)ã€‚æ­¤ä½œä¸šå†…éƒ¨å°†è¿è¡Œ`cargo clippy`å‘½ä»¤ã€‚
  - ä½œä¸š: Trunkï¼š- å°è¯•ä¸º wasm32-unknown-unknown ç›®æ ‡æ„å»ºé¡¹ç›®ï¼Œä¸ä¹‹å‰çš„æ“ä½œç±»ä¼¼ã€‚
- `pages.yml` - åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†å†æ¬¡ä½¿ç”¨ Trunkï¼Œå¹¶ä½¿ç”¨å‘½ä»¤`trunk build --release --public-url "${GITHUB_REPOSITORY#*/}"`æ¥æ”¶é›†æˆ‘ä»¬çš„æ‰€æœ‰æ–‡ä»¶ï¼Œå¹¶å°†å®ƒä»¬æ”¾ç½®åœ¨æˆ‘ä»¬å­˜å‚¨åº“çš„`gh-pages`åˆ†æ”¯ä¸­ã€‚
- `build_binaries.yml` - å°†è´Ÿè´£ä¸º Windows ç³»ç»Ÿæ„å»ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚å®Œæˆçš„å¯æ‰§è¡Œæ–‡ä»¶å°†ä½œä¸ºæ„å»ºçš„ä¸€éƒ¨åˆ†é™„åŠ åˆ°å­˜æ¡£ä¸­ã€‚

<details>
  <summary>Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° rust.yml:</summary>

	```yml
	# .github/workflows/rust.yml
	
	on: [push, pull_request]  
	  
	name: CI  
	  
	env:  
	  # This is required to enable the web_sys clipboard API which egui_web uses  
	  # https://rustwasm.github.io/wasm-bindgen/api/web_sys/struct.Clipboard.html  # https://rustwasm.github.io/docs/wasm-bindgen/web-sys/unstable-apis.html  RUSTFLAGS: --cfg=web_sys_unstable_apis  
	  
	jobs:  
	  check:  
	    name: Check  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3  
	      - uses: actions-rs/toolchain@v1  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          override: true  
	      - uses: actions-rs/cargo@v1  
	        with:  
	          command: check  
	          args: --all-features  
	  
	  check_wasm:  
	    name: Check wasm32  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3  
	      - uses: actions-rs/toolchain@v1  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          target: wasm32-unknown-unknown  
	          override: true  
	      - uses: actions-rs/cargo@v1  
	        with:  
	          command: check  
	          args: --all-features --lib --target wasm32-unknown-unknown  
	  
	  test:  
	    name: Test  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3  
	      - uses: actions-rs/toolchain@v1  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          override: true  
	      - run: sudo apt-get install libxcb-render0-dev libxcb-shape0-dev libxcb-xfixes0-dev libxkbcommon-dev libssl-dev  
	      - uses: actions-rs/cargo@v1  
	        with:  
	          command: test  
	          args: --lib  


â€‹	  
	  clippy:  
	    name: Clippy  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3  
	      - uses: actions-rs/toolchain@v1  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          override: true  
	          components: clippy  
	      - uses: actions-rs/cargo@v1  
	        with:  
	          command: clippy  
	          args: -- -D warnings  
	  
	  trunk:  
	    name: trunk  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3  
	      - uses: actions-rs/toolchain@v1  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          target: wasm32-unknown-unknown  
	          override: true  
	      - name: Rust Cache # cache the rust build artefacts  
	        uses: Swatinem/rust-cache@v1  
	      - name: Download and install Trunk binary  
	        run: wget -qO- https://github.com/thedodd/trunk/releases/latest/download/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-  
	      - name: Build  
	        run: ./trunk build
	```
</details>

<details>
  <summary>Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° pages.yml:</summary>

	```yml
	# .github/workflows/pages.yml
	
	name: Github Pages  
	  
	# By default, runs if you push to master. keeps your deployed app in sync with master branch.  
	on:  
	  push:  
	    branches:  
	      - master  
	# to only run when you do a new github release, comment out above part and uncomment the below trigger.  
	# on:  
	#   release:  
	#     types:  
	#       - published  
	  
	permissions:  
	  contents: write # for committing to gh-pages branch.  
	  
	jobs:  
	  build-github-pages:  
	    runs-on: ubuntu-latest  
	    steps:  
	      - uses: actions/checkout@v3 # repo checkout  
	      - uses: actions-rs/toolchain@v1 # get rust toolchain for wasm  
	        with:  
	          profile: minimal  
	          toolchain: stable  
	          target: wasm32-unknown-unknown  
	          override: true  
	      - name: Rust Cache # cache the rust build artefacts  
	        uses: Swatinem/rust-cache@v1  
	      - name: Download and install Trunk binary  
	        run: wget -qO- https://github.com/thedodd/trunk/releases/latest/download/trunk-x86_64-unknown-linux-gnu.tar.gz | tar -xzf-  
	      - name: Build # build  
	        # "${GITHUB_REPOSITORY#*/}" evaluates into the name of the repository        # using --public-url something will allow trunk to modify all the href paths like from favicon.ico to repo_name/favicon.ico .        # this is necessary for github pages where the site is deployed to username.github.io/repo_name and all files must be requested        # relatively as eframe_template/favicon.ico. if we skip public-url option, the href paths will instead request username.github.io/favicon.ico which        # will obviously return error 404 not found.        run: ./trunk build --release --public-url "${GITHUB_REPOSITORY#*/}"  
	      - name: Deploy  
	        uses: JamesIves/github-pages-deploy-action@v4  
	        with:  
	          folder: dist  
	          # this option will not maintain any history of your previous pages deployment  
	          # set to false if you want all page build to be committed to your gh-pages branch history          single-commit: true
	```
</details>

<details>
  <summary>Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° build_binaries.yml:</summary>

  ```yml
	# .github/workflows/build_binaries.yml
	name: Build binaries  
	  
	on:  
	  push:  
	    branches:  
	      - master  
	  
	jobs:  
	  windows-msvc-release:  
	    name: release windows msvc  
	    runs-on: windows-latest  
	    steps:  
	      - uses: actions/checkout@master  
	      - name: Build  
	        run: |  
	          cargo build --release  
	      - name: Upload artifact  
	        uses: actions/upload-artifact@v3  
	        with:  
	          name: windows-msvc.calculator-wasm-rust-pwa.archive.tar.gz  
	          path: ./target/release/calculator-wasm-rust-pwa.exe

  ```
</details>


Ğ”Ğ°, Ğ¿Ñ€Ğ¸ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğ¸ Ğ²ÑĞµÑ…ä¸‰ä¸ªæ–‡ä»¶åï¼Œå½“å‘ master åˆ†æ”¯æäº¤æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨å­˜å‚¨åº“çš„â€œActionsâ€é€‰é¡¹å¡ä¸­çœ‹åˆ°å·²æ’é˜Ÿçš„ä½œä¸šã€‚.

![Screenshot3.png](img/Screenshot3.png)

å®Œæˆäº† GitHub Pages ç»„ä¸­çš„å·¥ä½œåï¼Œè¯·åŠ¡å¿…æ£€æŸ¥æ‚¨å­˜å‚¨åº“ä¸­çš„åˆ†æ”¯ã€‚å…¶ä¸­åº”è¯¥å‡ºç°ä¸€ä¸ªåä¸º `gh-pages` çš„åˆ†æ”¯ï¼Œå…¶ä¸­åŒ…å«æ‰€æœ‰å¿…è¦çš„æ–‡ä»¶ã€‚

å‰©ä¸‹çš„æ˜¯åœ¨ GitHub ç½‘ç«™ä¸Šè®¾ç½® GitHub Pagesã€‚å¦‚æœæœ‰äººä¹‹å‰è¿˜æ²¡æœ‰è¿™æ ·åšï¼Œè¦è®¾ç½® GitHub Pagesï¼Œæ‚¨éœ€è¦è½¬åˆ°å­˜å‚¨åº“çš„â€œè®¾ç½®â€éƒ¨åˆ†ï¼Œç„¶ååœ¨ä¾§è¾¹æ çš„â€œä»£ç å’Œè‡ªåŠ¨åŒ–â€éƒ¨åˆ†é€‰æ‹©â€œé¡µé¢â€ã€‚ åœ¨æ‰“å¼€çš„é¡µé¢ä¸­ï¼Œåœ¨â€œåˆ†æ”¯â€éƒ¨åˆ†ä¸­é€‰æ‹©æˆ‘ä»¬çš„ `gh-pages` åˆ†æ”¯ï¼ˆè¯·è®°ä½ï¼Œæ­¤åˆ†æ”¯æ˜¯ç”±å…ˆå‰åœ¨ `build_binaries.yml` æ–‡ä»¶ä¸­è®¾ç½®çš„å·¥ä½œäººå‘˜è‡ªåŠ¨åˆ›å»ºçš„ï¼‰ã€‚ æˆ‘ä»¬å°†è·¯å¾„ä¿ç•™ä¸º `/(root)`ã€‚ ç„¶åç‚¹å‡»ä¿å­˜ï¼ˆSaveï¼‰ã€‚

ç°åœ¨ï¼Œæ‚¨çš„åº”ç”¨ç¨‹åºå·²ç»éƒ¨ç½²ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ `username.github.io/repo_name` è®¿é—®ã€‚.

## 3. æ·»åŠ è®¡ç®—å™¨ç•Œé¢

### 3.1 æ·»åŠ é”®ç›˜

å¯èƒ½æ¯ä¸ªäººéƒ½è§è¿‡å„ç§å„æ ·çš„è®¡ç®—å™¨é”®ç›˜å¸ƒå±€ï¼Œå› æ­¤æ¯ä¸ªäººéƒ½å¯ä»¥é€‰æ‹©é€‚åˆè‡ªå·±çš„å¸ƒå±€ã€‚

æˆ‘é€‰æ‹©äº†ä»¥ä¸‹å¸ƒå±€ï¼š

```
 âˆš   C   (   )   <=  
sin  7   8   9   *  
cos  4   5   6   /  
 tg  1   2   3   -  
ctg  .   0   =   +
```

ç°åœ¨ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨ EGUI çš„åŠŸèƒ½å°†è¿™ä¸ªå¸ƒå±€æè¿°åœ¨ä»£ç ä¸­ã€‚

é¦–å…ˆï¼Œè®©æˆ‘ä»¬å›é¡¾ä¸€ä¸‹æˆ‘ä»¬å·²ç»ç¼–å†™çš„`update(...)`å‡½æ•°ï¼š

```rust
impl eframe::App for CalcApp {  
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {  
        egui::CentralPanel::default().show(ctx, |ui| {  
            ui.label(r#"    
           è¿™æ˜¯ä¸€ä¸ªè™šæ„çš„è®¡ç®—å™¨ã€‚

è¦ä½¿ç”¨è®¡ç®—å™¨ï¼Œæ‚¨éœ€è¦å‘æŒ¥æƒ³è±¡åŠ›ã€‚è®©æˆ‘ä»¬æƒ³è±¡ä¸€ä¸ªç±»ä¼¼è®¡ç®—å™¨ç•Œé¢çš„ç•Œé¢ï¼Œå¹¶åœ¨å…¶ä¸­é”®å…¥ä¸€ä¸ªæ•°å­¦è¡¨è¾¾å¼ï¼Œç„¶åæŒ‰ä¸‹â€œ=â€æŒ‰é’®ã€‚

çœ‹åˆ°ç»“æœäº†å—ï¼Ÿæ­å–œï¼Œæ‚¨çš„è®¡ç®—å™¨å·¥ä½œå¾—å¾ˆå¥½ã€‚

            "#);  
        });  
    }  
}
```

ç°åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æè¿°äº†ä¸€ä¸ªæ·»åŠ äº†ä¸€ä¸ªå¸¦æœ‰é™æ€æ–‡æœ¬çš„ `label` å…ƒç´ çš„ä»£ç ã€‚è®©æˆ‘ä»¬å°†å…¶æ›¿æ¢ä¸ºæŒ‰é’®ï¼Œä½†é¦–å…ˆè®©æˆ‘ä»¬å°è¯•å¼„æ¸…æ¥šè¿™ä¸ªå‡½æ•°æ˜¯ç”±ä»€ä¹ˆç»„æˆçš„ã€‚

å‡½æ•° `update(...)` åœ¨ç±»å‹ï¼ˆç‰¹è´¨/ç‰¹å¾ï¼‰ `eframe::App` ä¸­å®šä¹‰ï¼Œæ ¹æ®æ³¨é‡Šï¼š:

```text
å®ƒåœ¨ç”¨æˆ·ç•Œé¢éœ€è¦é‡æ–°ç»˜åˆ¶æ—¶æ¯æ¬¡éƒ½ä¼šè¢«è°ƒç”¨ï¼Œè¿™å¯èƒ½ä¼šåœ¨ä¸€ç§’é’Ÿå†…å‘ç”Ÿå¤šæ¬¡ã€‚

å°†æ‚¨çš„å°éƒ¨ä»¶æ”¾ç½®åœ¨ [`egui::SidePanel`]ã€[`egui::TopBottomPanel`]ã€[`egui::CentralPanel`]ã€[`egui::Window`] æˆ– [`egui::Area`] ä¸­ã€‚

å¦‚æœéœ€è¦å¼ºåˆ¶é‡æ–°ç»˜åˆ¶ï¼Œè¯·éšæ—¶è°ƒç”¨ [`egui::Context::request_repaint`]ï¼ˆä¾‹å¦‚ï¼Œä»å¦ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚

```

ä½œä¸ºå‚æ•°ï¼Œè¯¥å‡½æ•°æ¥å—ä»¥ä¸‹å‚æ•°ï¼š

- `&mut self` - å¯¹æˆ‘ä»¬çš„ `CalcApp` ç»“æ„çš„å¯å˜å¼•ç”¨ã€‚
- `ctx: &egui::Context` - å®è´¨ä¸Šï¼Œæˆ‘ä»¬çš„ ctx æ˜¯å¯¹ Context ç»“æ„çš„å¼•ç”¨ï¼Œè¯¥ç»“æ„å…·æœ‰ä¸€ä¸ªæœªå‘½åçš„å‚æ•° - çº¿ç¨‹å®‰å…¨çš„å¼•ç”¨è®¡æ•°æŒ‡é’ˆï¼ˆArcï¼‰ã€‚
- `frame: &mut Frame` - è¿™æ˜¯å¯¹æ‚¨çš„åº”ç”¨ç¨‹åºç¯å¢ƒçš„å¯å˜å¼•ç”¨ã€‚å®ƒæä¾›äº†æ£€æŸ¥ç¯å¢ƒã€æ”¾ç½®çº¹ç†å’Œæ›´æ”¹è®¾ç½®ï¼ˆä¾‹å¦‚çª—å£å¤§å°ï¼‰çš„æ–¹æ³•ã€‚

æˆ‘ä»¬å¼€å§‹æ—¶ä¸éœ€è¦è¯¦ç»†äº†è§£è¿™äº›å˜é‡ï¼Œä½†éšç€æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå˜å¾—æ›´åŠ å¤æ‚ï¼Œæˆ‘ä»¬å°†ä¸å¾—ä¸é€æ­¥æ­ç¤ºä¸€äº›å®ƒä»¬çš„ç‰¹æ€§å’ŒåŠŸèƒ½ã€‚

è®©æˆ‘ä»¬ç¼–è¾‘ `update(...)` å‡½æ•°å¹¶äº†è§£æ¯è¡Œä»£ç çš„å«ä¹‰ã€‚:

```rust
// ./src/main.rs

// ...
fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {  
	egui::CentralPanel::default().show(ctx, |ui| {  
		ui.horizontal(|ui| {  
		    let _ = ui.small_button("âˆš");  
		    let _ = ui.small_button("C");  
		    let _ = ui.small_button("(");  
		    let _ = ui.small_button(")");  
		    let _ = ui.small_button("<=");  
		});  
		ui.horizontal(|ui| {  
		    let _ = ui.small_button("sin");  
		    let _ = ui.small_button("7");  
		    let _ = ui.small_button("8");  
		    let _ = ui.small_button("9");  
		    let _ = ui.small_button("*");  
		});  
		ui.horizontal(|ui| {  
		    let _ = ui.small_button("cos");  
		    let _ = ui.small_button("4");  
		    let _ = ui.small_button("5");  
		    let _ = ui.small_button("6");  
		    let _ = ui.small_button("/");  
		});  
		ui.horizontal(|ui| {  
		    let _ = ui.small_button("tg");  
		    let _ = ui.small_button("1");  
		    let _ = ui.small_button("2");  
		    let _ = ui.small_button("3");  
		    let _ = ui.small_button("-");  
		});  
		ui.horizontal(|ui| {  
		    let _ = ui.small_button("ctg");  
		    let _ = ui.small_button(".");  
		    let _ = ui.small_button("0");  
		    let _ = ui.small_button("=");  
		    let _ = ui.small_button("+");  
		});
	}  
}
```

æ ¹æ®å¯¹ `update()` å‡½æ•°çš„æ³¨é‡Šå»ºè®®ï¼Œæˆ‘ä»¬åº”è¯¥å°†æˆ‘ä»¬çš„å°éƒ¨ä»¶æ”¾ç½®åœ¨é¢æ¿ä¸­ï¼š`egui::SidePanel`ã€`egui::TopBottomPanel`ã€`egui::CentralPanel`ã€`egui::Window`ã€`egui::Area`ï¼Œå› æ­¤æˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„ä»£ç ä¸­æ·»åŠ ï¼š:
```rust
egui::CentralPanel::default().show(ctx, |ui| {  
	// ...
}  
```

`egui::CentralPanel` ä¼šå°è¯•å ç”¨æ‰€æœ‰å¯ç”¨ç©ºé—´ï¼Œå› ä¸ºæˆ‘ä»¬è¿˜æ²¡æœ‰æ·»åŠ å…¶ä»–é¢æ¿ï¼Œæ‰€ä»¥å®ƒä¼šå ç”¨æ‰€æœ‰ç©ºé—´ã€‚åˆ›å»º `egui::CentralPanel` æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è°ƒç”¨ `show()` æ–¹æ³•ï¼Œè¯¥æ–¹æ³•éœ€è¦ä»¥ä¸‹å‚æ•°ï¼š

- `ctx: &Context` - æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡æè¿°ç¬¦ã€‚
- `add_contents: impl FnOnce(&mut Ui) -> R` - è¦æ±‚æˆ‘ä»¬åœ¨è°ƒç”¨ `show()` å‡½æ•°æ—¶ä½¿ç”¨é—­åŒ…ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ•è· `Ui`ã€‚

é€šè¿‡å®ç°é—­åŒ…ï¼Œæˆ‘ä»¬è·å¾—äº†è®¿é—® `ui` çš„èƒ½åŠ›ï¼Œå®ƒè¡¨ç¤ºå±å¹•ä¸Šçš„åŒºåŸŸï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸Šæ”¾ç½®æˆ‘ä»¬çš„ç•Œé¢å…ƒç´ ã€‚

ç”±äºæˆ‘ä»¬çš„é”®ç›˜ç•Œé¢å®é™…ä¸Šå°±æ˜¯ç”±äº”è¡Œç»„æˆçš„æ ¼å­ï¼Œæ¯è¡Œæœ‰äº”ä¸ªæŒ‰é’®ï¼Œå› æ­¤æˆ‘ä»¬å°†åˆ©ç”¨ egui çš„åŠŸèƒ½æ¥ç»„ç»‡æ°´å¹³å’Œå‚ç›´å¸ƒå±€ã€‚
ä¸ºæ­¤æˆ‘ä»¬å°†ä½¿ç”¨:

```rust
ui.horizontal(|ui| {  
	// ...
});
```

`ui.horizontal` å…è®¸æˆ‘ä»¬æ°´å¹³åœ°ç»„ç»‡æ‰€æœ‰åç»­å…ƒç´ ï¼Œå…¶ä¸­æ¯ä¸ªåç»­å…ƒç´ å°†ä½äºæ°´å¹³å¸ƒå±€ä¸­å‰ä¸€ä¸ªå…ƒç´ çš„å³ä¾§ã€‚

æ³¨æ„ï¼š*å®é™…ä¸Šï¼Œæˆ‘ä»¬çš„è®¡ç®—å™¨ç•Œé¢æ›´åƒæ˜¯ä¸€ä¸ªç½‘æ ¼ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `egui::Grid`ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªç®€å•çš„ç½‘æ ¼å¸ƒå±€ï¼Œå…¶å•å…ƒå§‹ç»ˆä»å·¦åˆ°å³ï¼Œä»ä¸Šåˆ°ä¸‹æ’åˆ—ã€‚åœ¨ä»£ç çš„åç»­éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†æ›¿æ¢æˆ‘ä»¬çš„ä»£ç ä»¥ä½¿ç”¨ `egui::Grid`ã€‚*

å¦‚æœæ‚¨å°è¯•è¿è¡Œæˆ‘ä»¬çš„ä»£ç ï¼ˆé€šè¿‡æ‰§è¡Œ `cargo run`ï¼‰ï¼Œæ‚¨å°†å¤§è‡´çœ‹åˆ°ä»¥ä¸‹ç»“æœã€‚:

![Screenshot4.png](img/Screenshot4.png)

å·²ç»æœ‰ä¸€äº›è¿›å±•äº†ï¼ä½†ç°åœ¨æˆ‘ä»¬æ‰€æœ‰çš„æŒ‰é’®éƒ½è‡ªåŠ¨è°ƒæ•´å…¶å¤§å°ä»¥é€‚åº”å…¶å†…å®¹ã€‚è¿™ä¸å®Œå…¨æ˜¯æˆ‘ä»¬æƒ³è¦çœ‹åˆ°çš„ï¼Œå› æ­¤è®©æˆ‘ä»¬æ›¿æ¢ä¹‹å‰ç¼–å†™çš„ä»£ç ï¼Œä»¥å£°æ˜å¹¶æ·»åŠ æŒ‰é’®åˆ°ç•Œé¢ã€‚

å°†:

```rust
ui.small_button("âˆš");
```
ĞĞ°:
```rust
ui.add_sized(  
    [58.0, 48.0],  
    egui::Button::new("âˆš").small(),  
)
```

è®©æˆ‘ä»¬å¯¹æ‰€æœ‰æŒ‰é’®æ‰§è¡Œç›¸åŒæ“ä½œï¼Œç„¶åçœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚:

![Screenshot5.png](img/Screenshot5.png)

å¾ˆå¥½ã€‚ä½†é€šå¸¸æŒ‰é’®éƒ½æœ‰ä¸€äº›å¤„ç†ç¨‹åºï¼Œç”¨äºæ‰§è¡ŒæŸäº›æœ‰ç”¨çš„æ“ä½œã€‚è¦æ·»åŠ æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†æŒ‰é’®çš„å·¦é”®çš„ä»£ç ï¼Œè¯·å°†ä»£ç æ›´æ”¹å¦‚ä¸‹ï¼š:
```rust
if ui.add_sized(  
    [58.0, 48.0],  
    egui::Button::new("âˆš").small(),  
).clicked() { 
	// TODO Ğ¢ÑƒÑ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½ ĞºĞ¾Ğ´ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ‰ĞµĞ»Ñ‡ĞºĞ°.
};
```

å¥½çš„ã€‚è®©æˆ‘ä»¬æš‚åœä¸€ä¸‹ï¼Œå¹¶å°†æˆ‘ä»¬çš„æ‰€æœ‰æ›´æ”¹æ¨é€åˆ° GitHubã€‚é€šè¿‡æ‰§è¡Œè¿™äº›æ“ä½œï¼Œæˆ‘ä»¬å¸Œæœ› GitHub ä¼šä¸ºæˆ‘ä»¬æ‰§è¡Œæ‰€æœ‰æ„å»ºï¼ˆåŒ…æ‹¬ Windows å’Œ Webï¼‰ï¼Œå¹¶æ›´æ–° `gh-pages` åˆ†æ”¯çš„å†…å®¹ã€‚åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿ä¸€åˆ‡éƒ½æ­£å¸¸è¿è¡Œã€‚

æ³¨æ„ï¼š*å¦‚æœæ‚¨çš„æµè§ˆå™¨æ˜¾ç¤ºæ—§å†…å®¹ï¼Œè¯·æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢ï¼ˆå¯¹äº Chromeï¼Œä½¿ç”¨ Ctrl + F5ï¼‰*ã€‚```


### 3.2 ç”¨é”®ç›˜é‡æ„ä»£ç â€

æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ªé”®ç›˜ç•Œé¢ï¼Œä½†æˆ‘ä»¬çš„ä»£ç å˜å¾—å†—é•¿ä¸”ä¸ä¾¿äºä½¿ç”¨ã€‚æˆ‘å»ºè®®æˆ‘ä»¬ç°åœ¨æ¥ä¿®å¤è¿™ä¸ªé—®é¢˜ã€‚

æ³¨ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬ä¸ä¸€å¼€å§‹å°±æŒ‰ç…§æˆ‘ä»¬éœ€è¦çš„æ–¹å¼ç¼–å†™ä»£ç å‘¢ï¼ŸåŸå› å¾ˆç®€å•ï¼Œåœ¨æœ€å¼€å§‹ï¼Œæˆ‘ä»¬ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼šæ²¡æœ‰å·¥ä½œç•Œé¢ï¼Œä¹Ÿä¸çŸ¥é“æˆ‘ä»¬çš„ä»£ç ä¼šæ˜¯ä»€ä¹ˆæ ·å­å’Œå¦‚ä½•å·¥ä½œã€‚å› æ­¤ï¼Œåœ¨ç¬¬ä¸€æ¬¡è¿­ä»£ä¸­ï¼Œæˆ‘ä»¬ä¸“æ³¨äºå¿«é€Ÿè·å¾—ä¸€ä¸ªå¯å·¥ä½œçš„ç•Œé¢ç¤ºä¾‹ã€‚ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†å®ƒï¼Œæˆ‘ä»¬å¯ä»¥æ”¾æ…¢è„šæ­¥ï¼ŒèŠ±ä¸€äº›æ—¶é—´é‡æ–°ç»„ç»‡ä»£ç ã€‚ç„¶è€Œï¼ŒæŒ‰ç…§åŒæ ·çš„é€»è¾‘ï¼Œæˆ‘ä»¬ä¸ä¼šè¯•å›¾ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰å·¥ä½œå¹¶è€ƒè™‘åˆ°æˆ‘ä»¬å°†æ¥éœ€è¦çš„æ‰€æœ‰ç‰¹æ€§ã€‚å¦‚æœæ‚¨æœ‰æ›´æ·±å…¥çš„äº†è§£ï¼ŒçŸ¥é“ç°åœ¨åº”è¯¥å¦‚ä½•è¿›è¡Œæ›´æ”¹ï¼Œè¯·éšæ„æ›´æ”¹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘åªæ˜¯æƒ³å±•ç¤ºä¸€äº›é€‰æ‹©ï¼Œè¯´æ˜æˆ‘ä»¬å¯ä»¥å¦‚ä½•ç»„ç»‡ä»£ç ã€‚

ç°åœ¨æˆ‘ä»¬å°†é”®ç›˜ä»£ç æ‹†åˆ†åˆ°ä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ä¸­ï¼Œå¹¶ç¨å¾®ä¿®æ”¹å®ƒã€‚

æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶`src/keyboard.rs`ã€‚:

```bash
touch ./src/keyboard.rs
```
ä¸è¦å¿˜è®°åœ¨`src/lib.rs`æ–‡ä»¶ä¸­æ³¨å†Œæ–°æ¨¡å—ï¼Œåªéœ€æ·»åŠ ä»¥ä¸‹è¡Œï¼š:
```rust
pub mod keyboard;
```

å¥½çš„ï¼Œè®©æˆ‘ä»¬ä»ç®€å•çš„å¼€å§‹ - æ·»åŠ ä¸€ä¸ªæŒ‰é’®ã€‚è®©æˆ‘ä»¬åœ¨`src/keyboard.rs`ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š:
```rust
// ./src/keyboard.rs
use eframe::egui;  
use eframe::egui::Widget;

pub struct CustomKey {  
    pub text: String,  
    pub width: f32,  
    pub height: f32,  
}  
  
impl CustomKey {  
    /// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²ÑƒÑ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚.  
    pub fn from(text: impl Into<String>) -> Self {  
        Self {  
            text: text.into(),  
            ..Default::default()  
        }  
    }  
    /// Ğ—Ğ°Ğ´Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ ĞºĞ½Ğ¾Ğ¿ĞºĞµ.  
    fn set_size(mut self, width: f32, height: f32) {  
        self.width = width;  
        self.height = height;  
    }  
}  
  
impl Default for CustomKey {  
    fn default() -> Self {  
        Self {  
            text: "".to_string(),  
            width: 58.0,  
            height: 48.0,  
        }  
    }  
}  
  
  
impl Widget for CustomKey {  
    fn ui(self, ui: &mut egui::Ui) -> egui::Response {  
        let btn = ui.add_sized(  
            [self.width, self.height],  
            egui::Button::new(self.text).small(),  
        );  
        btn  
    }  
}
```

æ˜ç™½äº†ï¼Œæˆ‘ä»¬çš„`CustomKey`ç»“æ„åŒ…æ‹¬ï¼š

- `text` - ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå°†æ˜¾ç¤ºåœ¨æŒ‰é’®ä¸Šã€‚
- `width` å’Œ `height` - æˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬æ¥è®¾ç½®æŒ‰é’®çš„å¤§å°ã€‚

è¯·æ³¨æ„æˆ‘ä»¬ä»`egui::Widget` trait å®ç°çš„ `ui` å‡½æ•°ã€‚`:

```rust
impl Widget for CustomKey {  
    fn ui(self, ui: &mut egui::Ui) -> egui::Response {  
        let btn = ui.add_sized(  
            [self.width, self.height],  
            egui::Button::new(self.text).small(),  
        );  
        btn  
    }  
}
```

å½“ç„¶ï¼Œä½ åº”è¯¥è®°å¾—æˆ‘ä»¬å¤šæ¬¡ç¼–å†™çš„ `update()` å‡½æ•°ï¼Œå®ƒæ¥è‡ª `src/main` æ–‡ä»¶ã€‚ç°åœ¨è¿™äº›ä»£ç å·²ç»æ•´æ´åœ°è½¬ç§»åˆ°äº†æ–°çš„ä½ç½®ã€‚ä½ ç°åœ¨å¯ä»¥å°è¯•ç©ä¸€ä¸‹ `src/main` æ–‡ä»¶ï¼Œå°è¯•æ›¿æ¢æ—§çš„æ·»åŠ æŒ‰é’®çš„ä»£ç ã€‚:
```rust
if ui.add_sized(  
    [58.0, 48.0],  
    egui::Button::new("âˆš").small(),  
).clicked() { 
	// TODO Ğ¢ÑƒÑ‚ Ğ±ÑƒĞ´ĞµÑ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‰ĞµĞ½ ĞºĞ¾Ğ´ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ‰ĞµĞ»Ñ‡ĞºĞ°.
};
```
Ğ½Ğ°:
```rust
if keyboard::CustomKey::from("âˆš")
	.set_size([58.0, 48.0])
	.ui(ui)
	.clicked() { };
```


å¥½çš„ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç»“æ„æ¥æè¿°æˆ‘ä»¬çš„é”®ç›˜ï¼ŒåŒ…æ‹¬æˆ‘ä»¬éœ€è¦çš„æ‰€æœ‰æŒ‰é’®ã€‚.

```rust
// ./src/keyboard.rs
pub struct CalcKeyboard<'a> {  
    buffer: &'a mut Vec<String>,  
    pub width: f32,  
    pub height: f32,  
}

// ...
```
æ˜ç™½äº†ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨é”®ç›˜ä½œä¸ºæŸç§ç•Œé¢ï¼Œå®ƒå°†ç¡®å®šå“ªä¸ªé”®è¢«æŒ‰ä¸‹å¹¶å°†ç›¸åº”çš„å­—ç¬¦ä¸²ä¼ é€’åˆ°æˆ‘ä»¬å®šä¹‰çš„ç¼“å†²åŒºï¼Œè¯¥ç¼“å†²åŒºæ˜¯ä¸€ä¸ªå¯å˜å¼•ç”¨åˆ°å­—ç¬¦ä¸²å‘é‡ï¼ˆåœ¨æ¥ä¸‹æ¥æˆ‘ä»¬å°†å†æ¬¡ä¿®æ”¹å®ƒï¼‰ã€‚

ç°åœ¨è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„é”®ç›˜åœ¨UIä¸Šè¿›è¡Œå¸ƒå±€ã€‚å°†ä»¥ä¸‹ä»£ç æ·»åŠ åˆ°`./src/keyboard.rs`ä¸­ã€‚:

```rust
// ./src/keyboard.rs

// TODO Ğ² Ğ´Ğ°Ğ»ÑŒĞ½ĞµĞ¹ÑˆĞµĞ¼ Ğ±ÑƒĞ´ÑƒÑ‚ Ğ·Ğ°Ğ¼ĞµĞ½ĞµĞ½Ğ¾ Ğ½Ğ° Enum  
static KEYS: [(&str, &str); 25] = [  
    ("âˆš", "âˆš("), ("C", ""), ("(", "("), (")", ")"), ("<=", ""),  
    ("sin", "sin("), ("7", "7"), ("8", "8"), ("9", "9"), ("*", "*"),  
    ("cos", "cos("), ("4", "4"), ("5", "5"), ("6", "6"), ("/", "/"),  
    ("tg", "tg("), ("1", "1"), ("2", "2"), ("3", "3"), ("-", "-"),  
    ("ctg", "ctg("), (".", "."), ("0", "0"), ("=", ""), ("+", "+")  
];

pub struct CalcKeyboard<'a> {  
    // ...
}

impl<'a> CalcKeyboard<'a> {  
    pub fn from_buffer(buffer: &'a mut Vec<String>) -> Self {  
        Self {  
            buffer,  
            width: 340.0,  
            height: 320.0,  
        }  
    }  
  
    pub fn show(mut self, ui: &mut egui::Ui) {  
        egui::Grid::new("keyboard")  
            .num_columns(5)  
            .max_col_width(self.width)  
            .show(ui, |ui| {  
                for (ind, (title, val)) in KEYS.iter().enumerate() {  
                    if ind % 5 == 0 && ind != 0 {  
                        ui.end_row();  
                    }  
                    if CustomKey::from(*title).ui(ui).clicked() {  
                        match *title {  
                            "C" => { self.buffer.clear(); }  
                            "<=" => { self.buffer.pop(); }  
                            _ => { self.buffer.push(val.to_string()); }  
                        }  
                        // TODO Ğ”Ğ°Ğ»ĞµĞµ Ğ¼Ñ‹ ÑÑ‚Ğ¾ ÑƒĞ´Ğ°Ğ»Ğ¸Ğ¼.  
                        println!("{:?}", self.buffer)  
                    };  
                }  
            });  
    }  
}

// ...
```

æ­£å¦‚ä¹‹å‰æ‰¿è¯ºçš„ï¼Œæˆ‘ä»¬å°†æŒ‰é’®å¸ƒå±€æ›´æ”¹ä¸ºäº†ç½‘æ ¼å¸ƒå±€ã€‚æˆ‘ä»¬ä½¿ç”¨äº†`egui::Grid`ã€‚è¯·æ³¨æ„ï¼Œä¸ºäº†æ¢è¡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`ui.end_row();`ã€‚

ç°åœ¨å‰©ä¸‹çš„æ˜¯ä¿®æ”¹æˆ‘ä»¬åœ¨ `src/main` æ–‡ä»¶ä¸­çš„ä»£ç ã€‚:

```rust
// ./src/main.rs

// ...
struct CalcApp {  
    math_exp: Vec<String>,  
}  
  
impl CalcApp {  
    fn new(_cc: &eframe::CreationContext<'_>) -> Self {  
        CalcApp {  
            math_exp: Vec::new(),  
        }  
    }  
}  
  
impl eframe::App for CalcApp {  
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {  
        egui::CentralPanel::default().show(ctx, |ui| {  
            keyboard::CalcKeyboard::from_buffer(&mut self.math_exp).show(ui)  
        });  
    }  
}
```

å¯¹äºæˆ‘ä»¬çš„`CalcApp`ç»“æ„ï¼Œæˆ‘ä»¬æ·»åŠ äº†`math_exp: Vec<String>`ã€‚å½“æˆ‘ä»¬åˆ›å»ºæˆ‘ä»¬çš„é”®ç›˜æ—¶ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¯¹å®ƒçš„å¯å˜å¼•ç”¨ã€‚

è¿™æ˜¯æˆ‘ä»¬å¯¹é”®ç›˜ä»£ç çš„å½“å‰æ›´æ”¹ã€‚æ˜¯çš„ï¼Œæˆ‘çŸ¥é“è¿˜æœ‰å¾ˆå¤šå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œä½†æ˜¯å½“å‰æˆ‘ä»¬å·²ç»æœ‰äº†æˆ‘ä»¬æ‰€éœ€çš„ç»“æœâ€”â€”æˆ‘ä»¬å·²ç»å‡å°‘äº†`update()`å‡½æ•°ä¸­çš„ä»£ç é‡ã€‚`.

### 3.3 æ·»åŠ å±å¹•

é€šå¸¸åœ¨é”®ç›˜ä¸Šè¾“å…¥å†…å®¹æ—¶ï¼Œæˆ‘ä»¬ä¹ æƒ¯åœ¨å±å¹•ä¸Šçœ‹åˆ°ç›¸åº”çš„å†…å®¹ã€‚è®©æˆ‘ä»¬åœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ä¹Ÿæ·»åŠ ä¸€ä¸ªå±å¹•ã€‚åœ¨eguiä¸­ï¼Œæœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨ `egui::Label`ã€‚å®ƒå…è®¸åœ¨å±å¹•ä¸Šæ˜¾ç¤ºæ–‡æœ¬ã€‚

æ—¢ç„¶æˆ‘ä»¬å·²ç»åˆ›å»ºäº†é”®ç›˜ï¼Œå¯¹æˆ‘ä»¬æ¥è¯´æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ä¸åº”è¯¥æ˜¯ä»€ä¹ˆé—®é¢˜ã€‚è®©æˆ‘ä»¬ä¿®æ”¹ä»£ç ï¼Œåœ¨ `./src/main.rs` ä¸­è¿›è¡Œæ·»åŠ ã€‚:

```rust 
// ./src/main.rs

// ...
impl eframe::App for CalcApp {  
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {  
		// Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ TopPanel. 
		// ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ ÑƒĞ±ĞµĞ´Ğ¸Ñ‚ĞµÑÑŒ, 
		// Ñ‡Ñ‚Ğ¾ Ğ²Ñ‹ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ğ»Ğ¸ ĞµĞµ Ğ¿ĞµÑ€ĞµĞ´ CentralPanel.
        egui::TopBottomPanel::top("screen_panel").show(ctx, |ui| {  
	        let expression = self.math_exp.join("");
            ui.add_sized(  
                [330.0, 70.0],  
                egui::Label::new(  
                    egui::RichText::new(expression)  
                        .font(egui::FontId::monospace(25.0))  
                ).wrap(true),  
            );  
        });  
		
		// ...
    }  
}
```
æ‚¨å¯èƒ½æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬æ˜ç¡®è®¾ç½®äº†å­—ä½“å¤§å°ä¸º25.0ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®è¦æ˜¾ç¤ºçš„æ–‡æœ¬é•¿åº¦æ¥è¿›è¡Œè®¡ç®—ã€‚

å¤ªå¥½äº†ï¼å¹²å¾—æ¼‚äº®ï¼ˆè‡ªå¤¸ä¸€ä¸‹ä¸æ˜¯åäº‹...å°±åƒè¿™æ ·ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬æœ‰äº†å¸¦æœ‰é”®ç›˜å’Œç”¨äºæ˜¾ç¤ºæ•°å­¦è¡¨è¾¾å¼çš„å±å¹•çš„ç•Œé¢ã€‚ 
![Screenshot6.png](https://img-storage-202310-1321408411.cos.ap-nanjing.myqcloud.com/img/202310301212093.png)

## 4 ç¼–å†™è®¡ç®—å™¨

**æ³¨æ„**: ä½œä¸ºä½œè€…ï¼Œæˆ‘æƒ³å¼•èµ·è¯»è€…å¯¹äº Rust ä¸­å¦‚ [EGUI](https://github.com/emilk/egui#quick-start) è¿™æ ·çš„å·¥å…·é›†çš„å…³æ³¨ï¼Œä»¥åŠèƒ½å¤Ÿåœ¨æµè§ˆå™¨å’Œè®¡ç®—æœºä¸Šè¿è¡Œçš„å›¾å½¢ç•Œé¢çš„å¯èƒ½æ€§ã€‚è¿™ä¸ªç›®æ ‡å·²ç»å®ç°ã€‚ä½†æ˜¯ï¼Œè®¡ç®—å™¨å¦‚æœä¸èƒ½æ‰§è¡Œç®—æœ¯è¿ç®—å°±ä¸æ˜¯çœŸæ­£çš„è®¡ç®—å™¨ï¼Œå› æ­¤æˆ‘å†³å®šæè¿°å¦‚ä½•å°†è¿™ä¸ªåŠŸèƒ½æ·»åŠ åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºä¸­ã€‚å°½ç®¡æ˜¯ä»“ä¿ƒä¹‹é—´å®Œæˆçš„ï¼Œä½†å¯èƒ½å¯¹è¯»è€…æ¥è¯´çœ‹èµ·æ¥å¹¶ä¸æ˜¯å¾ˆâ€œæˆç†Ÿâ€ã€‚

è§£ææ•°å­¦è¡¨è¾¾å¼å¹¶å°†å…¶è¡¨ç¤ºä¸º[é€†æ³¢å…°è¡¨è¾¾å¼](https://en.wikipedia.org/wiki/Reverse_Polish_notation "é€†æ³¢å…°è¡¨è¾¾å¼")æˆ–[æŠ½è±¡è¯­æ³•æ ‘](https://en.wikipedia.org/wiki/Abstract_syntax_tree "æŠ½è±¡è¯­æ³•æ ‘")ä¸æ˜¯æœ¬æ–‡çš„ä¸»é¢˜ï¼Œä¸ä¼šè¯¦ç»†è®¨è®ºï¼Œä½†ä»ç„¶æ˜¯éå¸¸æœ‰è¶£çš„ï¼ˆåœ¨ä½œè€…çœ‹æ¥ï¼Œæ¯”åˆ›å»ºå¸¦æœ‰æŒ‰é’®çš„ç•Œé¢æ›´æœ‰è¶£ï¼‰ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ä¸€ä¸ªå¯ä»¥è®©æˆ‘ä»¬æ„å»ºåŒ…å«æ•°å­¦è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²çš„ç•Œé¢ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†è¯¥è¡¨è¾¾å¼æ‹†åˆ†ä¸ºæ ‡è®°ï¼ˆæ“ä½œæ•°ã€æ“ä½œç¬¦ã€å‡½æ•°ç­‰ï¼‰ã€‚å¦‚æœä½ çŸ¥é“å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘å»ºè®®ä¸è¦é˜…è¯»ä¸‹ä¸€èŠ‚ï¼Œè€Œæ˜¯è‡ªå·±å®ç°å®ƒã€‚å¦‚æœä½ ä¸ç†è§£è¿™æ˜¯ä»€ä¹ˆï¼Œä»æœªå°è¯•è¿‡ç±»ä¼¼çš„äº‹æƒ…ï¼Œæˆ‘ä¹Ÿå»ºè®®ä½ é¦–å…ˆé˜…è¯»ä¸€äº›ç›¸å…³å†…å®¹å¹¶åœ¨ä½ å–œæ¬¢çš„ç¼–ç¨‹è¯­è¨€ä¸Šå®ç°ä½ è‡ªå·±çš„æ ‡è®°è§£æå™¨ã€‚

å¯¹äºé‚£äº›ç•™ä¸‹æˆ–åœ¨å®Œæˆä»–ä»¬è‡ªå·±çš„æ ‡è®°è§£æå™¨åå›æ¥çš„äººï¼Œæˆ‘è¦è¯´çš„æ˜¯ï¼Œæˆ‘ä¸ä¼šå®ç°å­—ç¬¦ä¸²è§£æå™¨ã€‚ç›¸åï¼Œæˆ‘ä»¬å°†åšä»¥ä¸‹äº‹æƒ…:

- ä¸ºæ¯ä¸ªé”®åˆ†é…ä¸€ä¸ªæ ‡è®°ã€‚
- å®šä¹‰å°†æ ‡è®°æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„è§„åˆ™ã€‚
- ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œå°†å¸®åŠ©æˆ‘ä»¬å°†æˆ‘ä»¬çš„æ ‡è®°å‘é‡è¡¨ç¤ºä¸ºé€†æ³¢å…°è¡¨è¾¾å¼ã€‚
- æ·»åŠ å¦ä¸€ä¸ªå±å¹•æ¥æ˜¾ç¤ºç»“æœã€‚

### 4.1 æ·»åŠ  Tokens

æˆ‘ä»¬è®¡ç®—å™¨çš„æœ€ç»ˆç›®æ ‡æ˜¯è®¡ç®—æ•°å­¦ï¼ˆä»£æ•°ï¼‰è¡¨è¾¾å¼ã€‚é€šå¸¸ï¼Œæ•°å­¦è¡¨è¾¾å¼è¢«ç†è§£ä¸ºä¸€äº›å€¼ã€æ“ä½œå’Œå‡½æ•°çš„ç»„åˆï¼Œå¦‚æœéµå¾ªä¸€äº›è§„åˆ™ï¼Œæˆ‘ä»¬æˆ–è®¡ç®—æœºå¯ä»¥è§£é‡Šå®ƒã€‚ç„¶åï¼Œæˆ‘ä»¬å°†æŠŠè¿™ç§ç»„åˆçš„æ¯ä¸ªå•ç‹¬çš„å…ƒç´ ç§°ä¸ºâ€œæ ‡è®°â€ã€‚æˆ‘ä»¬çš„æœªæ¥æ ‡è®°å°†å—åˆ°ä¸€äº›å­ç±»å‹çš„é™åˆ¶ï¼š

- æ“ä½œæ•° - åœ¨æˆ‘ä»¬çš„è¡¨è¾¾å¼ä¸­ï¼Œä¸å„ç§ç®—æœ¯æ“ä½œä¸€èµ·ä½¿ç”¨çš„æ•°å­—ã€‚*é€šå¸¸ï¼Œæ“ä½œæ•°å¯ä»¥æ˜¯å•ç‹¬çš„æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•´ä¸ªæ•°å­¦è¡¨è¾¾å¼ã€‚ä½†æ˜¯å¯¹äºæˆ‘ä»¬çš„ä¾‹å­ï¼Œæˆ‘ä»¬å°†åªè€ƒè™‘æ•°å­—ä½œä¸ºæ“ä½œæ•°ã€‚*

- æ“ä½œ - è¡¨è¾¾å¼ä¸­çš„ç¬¦å·æˆ–ç¬¦å·åºåˆ—ï¼Œç”¨äºå¯¹æ“ä½œæ•°æ‰§è¡Œç®—æœ¯æˆ–é€»è¾‘æ“ä½œã€‚

- å‡½æ•° - å‡½æ•°çš„æ›´åŸå§‹å®šä¹‰å°†æ˜¯ä¸€ç§æè¿°ä¸€ä¸ªé‡å¦‚ä½•ä¾èµ–äºå¦ä¸€ä¸ªé‡çš„ç†æƒ³åŒ–ã€‚*æˆ‘ä»¬ä¸ä¼šæ·±å…¥ç ”ç©¶å®šä¹‰ï¼Œåªæ˜¯ç®€å•åœ°è¯´ï¼Œå¯¹äºæˆ‘ä»¬çš„ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†åªå¤„ç†ä¸€å…ƒå‡½æ•°ã€‚*

è®©æˆ‘ä»¬åœ¨ä»£ç ä¸­æè¿°è¿™ä¸€ç‚¹ã€‚ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæˆ‘ä»¬å°†æŠŠæˆ‘ä»¬æœªæ¥çš„æ ‡è®°ä»£ç æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„æ¨¡å— `./src/token.rs` ä¸­ï¼ˆä¸è¦å¿˜è®°å°†å…¶æ·»åŠ åˆ° lib.rsï¼‰ã€‚:

```rust
// ./src/token.rs
pub enum Token {  
    /// ĞĞ´Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.  
    Function,  
    /// ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ Ñ‡Ğ¸ÑĞ»Ğ°Ğ¼Ğ¸.  
    Operation,  
    /// Ğ§Ğ¸ÑĞ»Ğ¾ (Ğ²ĞµÑ‰ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ).  
    Operand,  
}
```

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨äº†`Enum`ï¼ˆæšä¸¾ï¼‰ã€‚æˆ‘ä»¬çš„æ¯ä¸ªæ–°æšä¸¾å®šä¹‰éƒ½å¯ä»¥åŒ…å«å¯¹å…¶ä»–æšä¸¾çš„å¼•ç”¨ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä¸€ä¸ªæ“ä½œæšä¸¾ï¼Œå…¶ä¸­åˆ—å‡ºåƒåŠ æ³•ã€å‡æ³•ç­‰æ“ä½œã€‚è®©æˆ‘ä»¬æ¥åšè¿™ä¸ªï¼Œå†å¤šåšä¸€äº›ã€‚:
```rust
// ./src/token.rs
  
pub enum Func {  
    Sin,  
    Cos,  
    Tg,  
    Ctg,  
    Sqrt,  
}  
  
pub enum Op {  
    /// Ğ¡Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ½Ğ°ĞºÑƒ '+'.  
    Add,  
    /// Ğ’Ñ‹Ñ‡Ğ¸Ñ‚Ğ°Ğ½Ğ¸Ğµ - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ½Ğ°ĞºÑƒ '-'.  
    Sub,  
    /// Ğ£Ğ¼Ğ½Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ½Ğ°ĞºÑƒ '*'.  
    Multi,  
    /// Ğ”ĞµĞ»ĞµĞ½Ğ¸Ğµ - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ½Ğ°ĞºÑƒ '/'.  
    Div,  
    /// Ğ’Ğ¾Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ² ÑÑ‚ĞµĞ¿ĞµĞ½ÑŒ - ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ Ğ·Ğ½Ğ°ĞºÑƒ '^'.  
    Exp,  
    /// Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ»Ñ‹ Ğ¾Ğ³Ñ€Ğ°Ğ½Ğ¸Ñ‡ĞµĞ½Ğ¸Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ğ¹.  
    ParenLeft,  
    ParenRight,  
}  
  
pub enum Token {  
    /// ĞĞ´Ğ¸Ğ½Ğ°Ñ€Ğ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸.  
    Function(Func),  
    /// ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ½Ğ°Ğ´ Ñ‡Ğ¸ÑĞ»Ğ°Ğ¼Ğ¸.  
    Operation(Op),  
    /// Ğ§Ğ¸ÑĞ»Ğ¾ (Ğ²ĞµÑ‰ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğµ).  
    Operand(f64),  
}
```

å¥½ä¸»æ„ï¼Œè®©æˆ‘ä»¬èŠ±ä¸€ç‚¹æ—¶é—´çœ‹çœ‹æˆ‘ä»¬æ˜¯å¦é—æ¼äº†ä»€ä¹ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„é”®ç›˜ã€‚:
```
 âˆš   C   (   )   <=  
sin  7   8   9   *  
cos  4   5   6   /  
 tg  1   2   3   -  
ctg  .   0   =   +
```

ä¼¼ä¹ä¸€åˆ‡éƒ½å·²å°±ä½ï¼Œä½†ç°åœ¨ï¼Œæ·»åŠ äº†æ–°ç»“æ„åï¼Œæˆ‘ä»¬å°±å¤±å»äº†ä»¥å¸¸ç”¨ç¬¦å·â€œ+â€ã€â€œ-â€ç­‰å½¢å¼è¡¨ç¤ºå®ƒä»¬çš„æœºä¼šã€‚

è®©æˆ‘ä»¬ä¸ºæ¯ä¸ªç»“æ„å®ç° `TryFrom` ç±»å‹ï¼ˆç‰¹å¾/ç‰¹å¾ï¼‰:

```rust
// ./src/token.rs
// ...
impl TryFrom<&str> for Op {  
    type Error = ();  
  
    fn try_from(s: &str) -> Result<Self, Self::Error> {  
        match s {  
            "^" => Ok(Op::Exp),  
            "/" => Ok(Op::Div),  
            "*" => Ok(Op::Multi),  
            "-" => Ok(Op::Sub),  
            "+" => Ok(Op::Add),  
            ")" => Ok(Op::ParenRight),  
            "(" => Ok(Op::ParenLeft),  
            _ => Err(())  
        }  
    }  
}
// ...

impl TryFrom<&str> for Token {  
    type Error = ();  
  
    fn try_from(s: &str) -> Result<Self, Self::Error> {  
        if let Ok(o) = Op::try_from(s) {  
            Ok(Token::Operation(o))  
        } else if let Ok(f) = Func::try_from(s) {  
            Ok(Token::Function(f))  
        } else if let Ok(val) = s.parse::<f64>() {  
            if val.is_infinite() {  
                Err(())  
            } else { Ok(Token::Operand(val)) }  
        } else { Err(()) }  
    }  
}
```

- å¥½çš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæˆ‘ä»¬çš„`Func`ç»“æ„æ‰§è¡Œç›¸åŒçš„æ“ä½œæ¥å®ç°`TryFrom`ã€‚*æˆ‘ä»¬å¯ä»¥é€šè¿‡å®ç°ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œå®ƒåªè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ¥ç®€åŒ–è¿™ä¸€åˆ‡ï¼Œä½†æˆ‘æƒ³è®©è¯»è€…ç†Ÿæ‚‰è¿™ä¸ª `TryFrom` ç‰¹è´¨ã€‚*

  ç„¶åï¼Œæˆ‘ä»¬è®¡åˆ’å°†æˆ‘ä»¬ç”¨ä½œç¼“å†²åŒºçš„`Vec<String>`æ›¿æ¢ä¸º`Vec<Token>`ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬ç°åœ¨å°è¯•è¿™æ ·åšï¼Œæˆ‘ä»¬å°†é¢ä¸´ä»¥ä¸‹å›°éš¾ï¼š

  æˆ‘ä»¬æ— æ³•åƒä¹‹å‰å¯¹`Vec<String>`ä½¿ç”¨`join`æ–¹æ³•ä¸€æ ·å¯¹`Vec<Token>`ä½¿ç”¨å®ƒã€‚:
```rust 
// ./src/main.rs
// ...
struct CalcApp {  
    math_exp: Vec<Token>,  // Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ String Ğ½Ğ° Token Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ°
}
// ...
fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {
	// ...
	let expression = self.math_exp.join("");
	// ...
```
- å½“æŒ‰ä¸‹æ“ä½œæŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å°†ç›¸åº”çš„æ ‡è®°æ·»åŠ åˆ°å‘é‡ä¸­ï¼Œä½†æ˜¯å½“æŒ‰ä¸‹æ•°å­—æŒ‰é’®æ—¶ï¼Œæˆ‘ä»¬æ— æ³•åšåˆ°è¿™ä¸€ç‚¹ï¼Œå› ä¸ºè¾“å…¥ä¸€ä¸ªæ•°å­—å¯èƒ½éœ€è¦å¤šæ¬¡æŒ‰ä¸‹æ•°å­—æŒ‰é’®ã€‚
- æ­¤å¤–ï¼Œæˆ‘ä»¬å¯èƒ½å¸Œæœ›åˆ¶å®šä¸€äº›è§„åˆ™ï¼Œä»¥ä¾¿å°†æˆ‘ä»¬çš„`Token`æ·»åŠ åˆ°å‘é‡ä¸­ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ç¦æ­¢è¿ç»­æ’å…¥ä¸¤ä¸ªæ“ä½œç¬¦å·å­—ç¬¦ï¼Œæˆ–è€…åœ¨é”®å…¥æ•°å­—æ—¶ç¦æ­¢æ’å…¥å¤šä¸ªå°æ•°ç‚¹ã€‚


### 4.2 æ·»åŠ  MathExp

å¥½çš„ï¼Œè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„æ¨¡å— `./src/math_exp.rs`ï¼Œå¹¶åœ¨å…¶ä¸­æè¿°æˆ‘ä»¬çš„æ–°ç»“æ„ã€‚:
```rust
// ./src/math_exp.rs
use crate::token;  
pub struct MathExp {  
    tokens: Vec<token::Token>,  
    buffer: String,  
    output: String,  
}
impl Default for MathExp {  
    fn default() -> Self {  
        Self::new()  
    }  
}  
  
impl MathExp {  
    pub fn new() -> Self {  
        Self {  
            tokens: Vec::new(),  
            buffer: String::new(),  
            output: String::new(),  
        }  
    }
}
```

åœ¨æˆ‘ä»¬çš„`MathExp`ç»“æ„ä¸­:

- `tokens` - ä¸€ä¸ªå‘é‡ï¼Œå…¶ä¸­åŒ…å«æŒ‰ç”¨æˆ·è¾“å…¥é¡ºåºæ”¾ç½®çš„æ ‡è®°ã€‚
- `buffer` - ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­è®°å½•ç”¨æˆ·è¾“å…¥çš„æ‰€æœ‰æ•°å­—ï¼Œç›´åˆ°è¾“å…¥ä¸æ“ä½œæˆ–å‡½æ•°ç›¸å¯¹åº”çš„å†…å®¹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°†å°è¯•å°†ç¼“å†²åŒºå­—ç¬¦ä¸²è½¬æ¢ä¸ºæ“ä½œæ•°æ ‡è®°ã€‚
- `output` - æˆ‘ä»¬å°†ç”¨å®ƒæ¥å­˜æ”¾è®¡ç®—ç»“æœå’Œé”™è¯¯æ¶ˆæ¯ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¿™ä¸ªç»“æ„ä½œä¸ºæ·»åŠ æ–°æ ‡è®°çš„å•ä¸€ç‚¹ï¼Œå¹¶ç”¨å®ƒæ¥è°ƒç”¨æœ€ç»ˆçš„è®¡ç®—ã€‚

è®©æˆ‘ä»¬å¯¹ä»¥ä¸‹æ–‡ä»¶è¿›è¡Œæ›´æ”¹ã€‚:

```rust
// ./src/keyboard.rs
use crate::math_exp;
// ...
pub struct CalcKeyboard<'a> {  
	// å–ä»£ buffer: &'a mut Vec<String>, Ğ½Ğ° buffer: &'a mut math_exp::MathExp, 
    buffer: &'a mut math_exp::MathExp,  
    // ...
}

impl<'a> CalcKeyboard<'a> {  
	// å–ä»£ pub fn from_buffer(buffer: &'a mut Vec<String>) -> Self {
    pub fn from_buffer(buffer: &'a mut math_exp::MathExp) -> Self {  
        Self {
	        // ...
        }
	    // ... 
     }   
// ...
```

```rust
// ./src/main.rs
use crate::math_exp;
// ...
struct CalcApp {  
	// Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ Vec<String>, Ğ½Ğ° math_exp::MathExp,  
    math_exp: math_exp::MathExp,  
}

impl CalcApp {  
    fn new(_cc: &eframe::CreationContext<'_>) -> Self {  
        CalcApp {  
	        // Ğ—Ğ°Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ Vec::new(), Ğ½Ğ° math_exp::MathExp::default(), 
            math_exp: math_exp::MathExp::default(),  
        }  
    }  
}

```rust 
// ./src/main.rs

// ...
impl eframe::App for CalcApp {  
    fn update(&mut self, ctx: &egui::Context, _frame: &mut eframe::Frame) {  
		// æ·»åŠ äº† TopPanelã€‚
		// ç¡®ä¿åœ¨ CentralPanel ä¹‹å‰æ·»åŠ å®ƒã€‚
        egui::TopBottomPanel::top("screen_panel").show(ctx, |ui| {  
	        // å°† `let expression = self.math_exp.join("");` æ›¿æ¢ä¸ºï¼š
	        let expression = self.math_exp.to_string();
            // ...  
        });  
    }  
}
```

å¥½çš„ï¼Œè®©æˆ‘ä»¬åœ¨è¿™é‡Œåœä¸‹æ¥ã€‚åœ¨`./src/main.rs`æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä»¥ä¸‹è¡Œï¼š:
```rust
let expression = self.math_exp.to_string();
```
å¥½çš„ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦åœ¨æˆ‘ä»¬çš„`MathExp`ç»“æ„ä¸­å®ç° `std::fmt::Display` ç‰¹è´¨ã€‚:
```rust
// ./src/math_exp.rs
// ...
impl std::fmt::Display for MathExp {  
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {  
        let mut o = String::new();  
        for token in &self.tokens {  
            o.push_str(token.to_string().as_str());  
            o.push(' ');  
        }  
        o.push_str(self.buffer.as_str());  
        write!(  
            f,  
            "{}",  
            o  
        )  
    }  
}
// ...
```

åªè¦æˆ‘ä»¬ä¸æ‹…å¿ƒä¼˜åŒ–ä»£ç ï¼Œæˆ‘ä»¬å°±ä¼šä»¥æœ€å¿«çš„æ–¹å¼å¾—åˆ°ç»“æœã€‚å¦‚æœæˆ‘ä»¬å°è¯•è¿è¡Œ`cargo build `ï¼Œæˆ‘ä»¬ä¼šæ³¨æ„åˆ°ç¼–è¯‘å™¨ä¼šæŠ±æ€¨æˆ‘ä»¬çš„`enum Token`æ²¡æœ‰å®ç°ç±»å‹ã€‚`std:: fmt: Displayã€‚`è®©æˆ‘ä»¬æŒ‰ç…§ç¼–è¯‘å™¨çš„è¦æ±‚å»åšã€‚:
```rust 
// ./src/token.rs
// ...
impl std::fmt::Display for Token {  
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {  
        write!(  
            f,  
            "{}",  
            match self {  
                Token::Function(func) => { func.to_string() }  
                Token::Operation(op) => { op.to_string() }  
                Token::Operand(o) => { o.to_string() }  
            }  
        )  
    }  
}
impl std::fmt::Display for Op {  
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {  
        write!(  
            f,  
            "{}",  
            match self {  
                Op::Add => { "+" }  
                Op::Sub => { "-" }  
                Op::Multi => { "*" }  
                Op::Div => { "/" }  
                Op::Exp => { "^" }  
                Op::ParenLeft => { "(" }  
                Op::ParenRight => { ")" }  
            }  
        )  
    }  
}
impl std::fmt::Display for Func {  
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {  
        write!(  
            f,  
            "{}",  
            match self {  
                Func::Sin => { "sin" }  
                Func::Cos => { "cos" }  
                Func::Tg => { "tg" }  
                Func::Ctg => { "ctg" }  
                Func::Sqrt => { "âˆš" }  
            }  
        )  
    }  
}
```

ç°åœ¨è®©æˆ‘ä»¬ä¸ºæˆ‘ä»¬çš„`MathExp`ç»“æ„å®ç°`add`ã€`pop`ã€`clear`å’Œ`calculate`å‡½æ•°ã€‚æˆ‘ä»¬å°†ä½¿ç”¨å®ƒä»¬ä½œä¸ºæŒ‰é”®æ“ä½œï¼š:
```rust
// ./src/keyboard.rs
// ...
impl<'a> CalcKeyboard<'a> {
	// ...
	pub fn show(self, ui: &mut egui::Ui) {
		// ...
		for (ind, title) in KEYS.iter().enumerate() {
			// ...
			if CustomKey::from(*title).ui(ui).clicked() {
				match *title {  
				    "C" => { self.buffer.clear(); }
				    "<=" => { self.buffer.pop(); }
				    "=" => { self.buffer.calculate(); }  
				    _ => { self.buffer.add(title); }
				}
// ..
```

`add`ã€`pop`å’Œ`clear`å‡½æ•°å°†éœ€è¦æˆ‘ä»¬å®æ–½å¯¹æ·»åŠ Tokené¡ºåºçš„æ£€æŸ¥ã€‚ä¾‹å¦‚ï¼Œå¦‚æœTokenå‘é‡ä¸ºç©ºï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¦æ­¢è¾“å…¥ä¹˜æ³•æ“ä½œï¼Œæˆ–è€…æˆ‘ä»¬å¯èƒ½ä¼šç¦æ­¢åœ¨å³æ‹¬å·ä¹‹åç«‹å³æ”¾ç½®å·¦æ‹¬å·ï¼ˆå‡è®¾å®ƒä»¬ä¹‹é—´åº”è¯¥æ˜¯ä¸€ä¸ªç®—æœ¯æ“ä½œï¼‰ã€‚.

<details>
  <summary>Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° ./src/math_exp.rs:</summary>


  ```rust
  
use crate::token;  
use crate::token::Weight;  
  
  
pub struct MathExp {  
    tokens: Vec<token::Token>,  
    buffer: String,  
    output: String,  
}  
  
impl Default for MathExp {  
    fn default() -> Self {  
        Self::new()  
    }  
}  
  
impl MathExp {  
    pub fn new() -> Self {  
        Self {  
            tokens: Vec::new(),  
            buffer: String::new(),  
            output: String::new(),  
        }  
    }  
  
    pub fn get_output(&self) -> String {  
        self.output.clone()  
    }  
  
    fn update_output(&mut self, s: &str) {  
        self.output = s.to_string();  
    }  
  
    /// æ ¹æ®è§„åˆ™æ’å…¥ä»¤ç‰Œï¼š
    /// * åœ¨æ“ä½œæ•°ï¼ˆæ•°å­—ï¼‰ä¹‹åå¿…é¡»æ˜¯æ“ä½œç¬¦æˆ–é—­æ‹¬å·ã€‚
    /// * åœ¨æ“ä½œç¬¦åé¢åªèƒ½æ˜¯å¼€æ‹¬å·æˆ–æ“ä½œæ•°ï¼ˆæ•°å­—ï¼‰ã€‚    fn push_to_token(&mut self, t: token::Token) {  
        fn push(tokens: &mut Vec<token::Token>, t: token::Token) {  
            if let token::Token::Function(_) = t {  
                tokens.push(t);  
                tokens.push(token::Token::Operation(token::Op::ParenLeft));  
            } else { tokens.push(t); }  
        }  
        //å¦‚æœæ’å…¥åé—­æ‹¬å·çš„æ•°é‡å°†è¶…è¿‡æ‰“å¼€æ‹¬å·çš„æ•°é‡ï¼Œåˆ™ç¦æ­¢æ’å…¥ã€‚       if let token::Token::Operation(token::Op::ParenRight) = t {  
            let mut count_paren: i32 = -1; // Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ² -1, Ñ‚.Ğº. Ğ² Ğ±ÑƒĞ´ÑƒÑ‰ĞµĞ¼ Ğ¼Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ğ¼ Ğ²ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ğ´Ğ½Ñƒ ÑĞºĞ¾Ğ±ĞºÑƒ.  
            for token in &self.tokens {  
                if let token::Token::Operation(p) = token {  
                    match p {  
                        token::Op::ParenLeft => { count_paren += 1 }  
                        token::Op::ParenRight => { count_paren -= 1 }  
                        _ => {}  
                    }  
                }  
            }  
            if count_paren < 0 { return; }  
        }  
  
  
        let last_token = self.tokens.last();  
        if last_token.is_none() {  
            //å½“æ ‡è®°åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œ
// æˆ‘ä»¬å°†ä»…å…è®¸æ’å…¥æ–°æ ‡è®°
// å¦‚æœå®ƒä»¬ä¸æ˜¯æ“ä½œæ ‡è®°ï¼ˆé™¤äº†å·¦æ‹¬å·æ ‡è®°ï¼‰ã€‚
if !matches!(t,token::Token::Operation(_)) || matches!(t,token::Token::Operation(token::Op::ParenLeft)) {           
            if !matches!(t,token::Token::Operation(_)) || matches!(t,token::Token::Operation(token::Op::ParenLeft)) {  
                push(&mut self.tokens, t);  
            }  
            return;  
        }  
        let last_token = last_token.unwrap();  
  
  
        let allow_insert = match last_token {  
            // ĞŸĞ¾ÑĞ»Ğµ Ñ‡Ğ¸ÑĞ»Ğ°:  
            token::Token::Operand(_) => {  
                match t {  
                    // Ğ—Ğ°Ğ¿Ñ€ĞµÑ‰Ğ°ĞµĞ¼ Ğ²ÑÑ‚Ğ°Ğ²ĞºÑƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸, Ñ‡Ğ¸ÑĞµĞ» Ğ¸Ğ»Ğ¸ Ğ»ĞµĞ²Ğ¾Ğ¹ ÑĞºĞ¾Ğ±ĞºĞ¸ Ğ¿Ğ¾ÑĞ»Ğµ Ñ‡Ğ¸ÑĞ»Ğ°.  
                    token::Token::Function(_) | token::Token::Operand(_) | token::Token::Operation(token::Op::ParenLeft) => { false }  
                    _ => { true }  
                }  
            }  
            // é—­åˆæ‹¬å·ä¹‹å:  
            token::Token::Operation(token::Op::ParenRight) => {  
                match t {  
                    token::Token::Operation(token::Op::ParenLeft) => { false }  
                    token::Token::Operation(_) => { true }  
                    _ => { false }  
                }  
            }  
            // æ‰‹æœ¯åï¼Œé™¤äº†é—­åˆæ‹¬å·ã€‚:  
            token::Token::Operation(_) => {  
                match t {  
                    token::Token::Operation(token::Op::ParenLeft) => { true }  
                    //æ‰‹æœ¯åç¦æ­¢æ’å…¥(é™¤å¼€æ‹¬å·å¤–).  
                    token::Token::Operation(_) => { false }  
                    _ => { true }  
                }  
            }  
  
            _ => { true }  
        };  
  
        if allow_insert {  
            push(&mut self.tokens, t);  
        } else {  
            self.update_output(format!("Ğ¢Ğ¾ĞºĞµĞ½ {} ä¹‹åä¸èƒ½æ·»åŠ  {}", t, last_token).as_str());  
        }  
        let mut s = String::new();  
        for token in &self.tokens {  
            s.push('[');  
            s.push_str(token.to_string().as_str());  
            s.push(']');  
            s.push(',');  
        }  
        println!("{s}")  
    }  
  
    //ä»ç¼“å†²åŒºä¸­åˆ é™¤å€¼ï¼Œå¹¶å°†å…¶ä¸ä»¤ç‰Œæ”¾åœ¨å‘é‡çš„æœ«å°¾ã€‚
/// ///å°†å°è¯•æ”¹å˜å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­çš„å€¼ã€‚ 
	fn pop_buffer(&mut self) -> bool {  
        if self.buffer.is_empty() { return true; }  
        if let Ok(val) = self.buffer.parse::<f64>() {  
            if val.is_sign_negative() {  
                self.tokens.push(token::Token::Operation(token::Op::ParenLeft));  
                self.tokens.push(token::Token::Operand(val));  
                self.tokens.push(token::Token::Operation(token::Op::ParenRight));  
                self.buffer.clear();  
            } else {  
                self.tokens.push(token::Token::Operand(val));  
                self.buffer.clear();  
            }  
            true  
        } else { false }  
    }  
  
    /// ä»çŸ¢é‡ä¸­åˆ é™¤æœ€åä¸€ä¸ªå€¼.  
    pub fn pop(&mut self) {  
        if self.buffer.is_empty() {  
            self.tokens.pop();  
            // å¦‚æœtokenè¢«åˆ é™¤äº†ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåˆ é™¤å®ƒã€‚.  
            if matches!(self.tokens.last(), Some(token::Token::Function(_))) { self.tokens.pop(); }  
        } else {  
            // å¦‚æœæˆ‘ä»¬åœ¨ç¼“å†²åŒºä¸­æœ‰å€¼ï¼Œæˆ‘ä»¬é¦–å…ˆä»ç¼“å†²åŒºä¸­åˆ é™¤å€¼.  
            self.buffer.pop();  
        }  
    }  
  
    /// ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ±ÑƒÑ„ĞµÑ€Ğ° Ğ¸ Ğ²ĞµĞºÑ‚Ğ¾Ñ€ Ñ Ñ‚Ğ¾ĞºĞµĞ½Ğ°Ğ¼Ğ¸.  
    pub fn clear(&mut self) {  
        self.buffer.clear();  
        self.tokens.clear();  
    }  
  
    /// ä½¿ç”¨æŒ‡å®šçš„å­—ç¬¦ä¸²åˆ›å»ºå¹¶æ·»åŠ æ–°çš„ Tokenã€‚
/// åœ¨ä»»ä½•æ·»åŠ æ“ä½œä¹‹å‰ï¼Œéƒ½ä¼šé¦–å…ˆæ£€æŸ¥æ˜¯å¦éœ€è¦å°†å­—ç¬¦ä¸²æ·»åŠ åˆ°ç¼“å†²åŒºã€‚
/// å¦‚æœå‡ºç°å¯ä»¥è§£é‡Šä¸ºæ“ä½œç¬¦æˆ–å‡½æ•°çš„å­—ç¬¦åºåˆ—ï¼Œåˆ™å°†å°è¯•ä»ç¼“å†²åŒºå¼¹å‡ºå½“å‰å€¼ï¼Œå¹¶ä»…åœ¨æ­¤ä¹‹åæ·»åŠ æ–°å€¼ã€‚
	pub fn add(&mut self, s: &str) -> bool {
        let allow_number_input = !matches!(  
            self.tokens.last(),  
            Some(token::Token::Operation(token::Op::ParenRight))  
        );  
  
        if s == "." && allow_number_input {  
            if self.buffer.is_empty() {  
                self.buffer = "0.".to_string();  
                true            } else if self.buffer.contains('.') {  
                // Ğ¼Ñ‹ Ğ½Ğµ Ğ¼Ğ¾Ğ¶ĞµĞ¼ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞ¸Ñ‚ÑŒ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ñ‡ĞµĞ¼ Ğ¾Ğ´Ğ½Ñƒ Ñ‚Ğ¾Ñ‡ĞºÑƒ.  
                false  
            } else {  
                self.buffer.push('.');  
                true            }  
        } else if s.parse::<u8>().is_ok() && allow_number_input {  
            self.buffer.push_str(s);  
            true        } else if self.buffer.is_empty() && s == "-" && allow_number_input {  
            self.buffer = s.to_string();  
            true        } else if let Ok(t) = token::Token::try_from(s) {  
            self.pop_buffer();  
            self.push_to_token(t);  
            true        } else { false }  
    }  
  
    pub fn calculate(&mut self) {  
        self.pop_buffer();  
        let rpn = yard(&self.tokens);  
        match rpn {  
            Err(e) => { self.output = e }  
            Ok(tokens) => {  
                let mut stack: Vec<token::Token> = Vec::new();  
                for t in tokens {  
                    if stack.is_empty() {  
                        stack.push(t);  
                    } else {  
                        match t {  
                            token::Token::Function(f) => {  
                                if let Some(token::Token::Operand(val)) = stack.pop() {  
                                    stack.push(match f {  
                                        token::Func::Sin => {  
                                            println!("sin({val})={}", val.sin());  
                                            token::Token::Operand(val.sin())  
                                        }  
                                        token::Func::Cos => {  
                                            println!("cos({val})={}", val.cos());  
                                            token::Token::Operand(val.cos())  
                                        }  
                                        token::Func::Tg => {  
                                            println!("Tg({val})={}", val.sin() / val.cos());  
                                            token::Token::Operand(val.sin() / val.cos())  
                                        }  
                                        token::Func::Ctg => {  
                                            println!("Ctg({val})={}", val.cos() / val.sin());  
                                            token::Token::Operand(val.cos() / val.sin())  
                                        }  
                                        token::Func::Sqrt => {  
                                            println!("Sqrt({val})={}", val.sqrt());  
                                            token::Token::Operand(val.sqrt())  
                                        }  
                                    });  
                                } else {  
                                    self.output = "ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸Ñ".to_string()  
                                }  
                            }  
                            token::Token::Operation(op) => {  
                                if let Some(token::Token::Operand(second_val)) = stack.pop() {  
                                    if let Some(token::Token::Operand(first_val)) = stack.pop() {  
                                        if let Some(val) = match op {  
                                            token::Op::Add => {  
                                                println!("{first_val}+{second_val}={}", first_val + second_val);  
                                                Some(first_val + second_val)  
                                            }  
                                            token::Op::Sub => {  
                                                println!("{first_val}-{second_val}={}", first_val - second_val);  
                                                Some(first_val - second_val)  
                                            }  
                                            token::Op::Multi => {  
                                                println!("{first_val}*{second_val}={}", first_val * second_val);  
                                                Some(first_val * second_val)  
                                            }  
                                            token::Op::Div => {  
                                                println!("{first_val}/{second_val}={}", first_val / second_val);  
                                                Some(first_val / second_val)  
                                            }  
                                            token::Op::Exp => {  
                                                println!("{first_val}^{second_val}={}", first_val.powf(second_val));  
                                                Some(first_val.powf(second_val))  
                                            }  
                                            _ => { None }  
                                        } { stack.push(token::Token::Operand(val)) }  
                                    } else { self.output = "é”™è¯¯è®¡ç®—".to_string() }  
                                } else { self.output = "é”™è¯¯è®¡ç®—".to_string() }  
                            }  
                            token::Token::Operand(_) => { stack.push(t); }  
                        }  
                    }  
                }  
                self.output = if let Some(t) = stack.pop() {  
                    self.buffer.clear();  
                    self.tokens.clear();  
                    t.to_string()  
                } else { "é”™è¯¯è®¡ç®—".to_string() };  
                println!("=> {}", self.output)  
            }  
        }  
    }  
}  
  
impl std::fmt::Display for MathExp {  
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {  
        let mut o = String::new();  
        for token in &self.tokens {  
            o.push_str(token.to_string().as_str());  
            o.push(' ');  
        }  
        o.push_str(self.buffer.as_str());  
        write!(  
            f,  
            "{}",  
            o  
        )  
    }  
}  
  
  
/// # è°ƒåº¦åœºç®—æ³•

/// [æ¥è‡ªç»´åŸºç™¾ç§‘ï¼Œè‡ªç”±çš„ç™¾ç§‘å…¨ä¹¦çš„èµ„æ–™](https://en.wikipedia.org/wiki/Shunting_yard_algorithm)

/// è°ƒåº¦åœºç®—æ³•æ˜¯ä¸€ç§è§£æä»¥ä¸­ç¼€ç¬¦å·è¡¨ç¤ºçš„æ•°å­¦è¡¨è¾¾å¼çš„æ–¹æ³•ã€‚å®ƒå¯ç”¨äºè·å–é€†æ³¢å…°è¡¨è¾¾å¼å½¢å¼çš„è¾“å‡ºæˆ–æŠ½è±¡è¯­æ³•æ ‘ã€‚è¯¥ç®—æ³•æ˜¯ç”±è‰¾å…¹èµ«Â·è¿ªç§‘æ–¯å½»æå‡ºçš„ï¼Œå¹¶ç”±ä»–å‘½åä¸ºâ€œè°ƒåº¦åœºç®—æ³•â€ï¼Œå› ä¸ºå®ƒç±»ä¼¼äºé“è·¯è°ƒè½¦åœºçš„æ“ä½œã€‚

/// åƒé€†æ³¢å…°è¡¨è¾¾å¼ä¸­çš„è¡¨è¾¾å¼æ±‚å€¼ä¸€æ ·ï¼Œè¯¥ç®—æ³•ä½¿ç”¨æ ˆè¿›è¡Œè®¡ç®—ã€‚æ•°å­¦è¡¨è¾¾å¼çš„ä¸­ç¼€ç¬¦å·é€šå¸¸ç”±äººä»¬ä½¿ç”¨ï¼Œä¾‹å¦‚ 2+4 å’Œ 3+6*(3-2)ã€‚ä¸ºäº†å°†å…¶è½¬æ¢ä¸ºé€†æ³¢å…°è¡¨è¾¾å¼ï¼Œä½¿ç”¨ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼šè¾“å…¥å­—ç¬¦ä¸²å’Œè¾“å‡ºå­—ç¬¦ä¸²ï¼Œä»¥åŠä¸€ä¸ªç”¨äºå­˜å‚¨å°šæœªæ·»åŠ åˆ°è¾“å‡ºé˜Ÿåˆ—ä¸­çš„è¿ç®—ç¬¦çš„å †æ ˆã€‚åœ¨è½¬æ¢è¿‡ç¨‹ä¸­ï¼Œè¯¥ç®—æ³•è¯»å–ä¸€ä¸ªå­—ç¬¦å¹¶æ ¹æ®å­—ç¬¦æ‰§è¡Œæ“ä½œã€‚ 
 
fn yard(input: &Vec<token::Token>) -> Result<Vec<token::Token>, String> {  
    let mut output: Vec<token::Token> = vec![];  
    let mut stack: Vec<token::Token> = vec![];  
    for token in input {  
        match token {  
            token::Token::Operand(_o) => {  
                // å¦‚æœä»¤ç‰Œæ˜¯ä¸€ä¸ªæ•°å­—ï¼Œå°†å…¶æ·»åŠ åˆ°è¾“å‡ºåˆ—è¡¨ä¸­.  
                output.push(token.clone())  
            }  
            token::Token::Function(_f) => {  
                stack.push(token.clone())  
            }  
            token::Token::Operation(token::Op::ParenLeft) => {  
                stack.push(token.clone())  
            }  
            token::Token::Operation(token::Op::ParenRight) => {  
                loop {  
                    if let Some(last_token_in_stack) = stack.pop() {  
                        match last_token_in_stack {  
                            token::Token::Operation(token::Op::ParenLeft) => {  
                                break;  
                            }  
                            _ => {  
                                output.push(last_token_in_stack.clone())  
                            }  
                        }  
                    } else {  
                        return Err("Ğ’ è¡¨è¾¾å¼æ²¡æœ‰æ‹¬å·ã€‚".to_string());  
                    }  
                }  
            }  
            token::Token::Operation(op1) => {  
                if let Some(token::Token::Operation(op2)) = stack.pop() {  
                    if op2.weight() >= op1.weight() {  
                        output.push(token::Token::Operation(op2))  
                    } else {  
                        stack.push(token::Token::Operation(op2))  
                    }                }  
  
                stack.push(token.clone())  
            }  
        }  
    }  
    while let Some(last_token_in_stack) = stack.pop() {  
        match last_token_in_stack {  
            token::Token::Operation(token::Op::ParenLeft) => {  
                return Err("Ğ’ è¡¨è¾¾å¼æ²¡æœ‰æ‹¬å·ã€‚.".to_string());  
            }  
            _ => { output.push(last_token_in_stack) }  
        }  
    }  
    Ok(output)  
}

  ```
</details>







